<div class="modal-header">
  <h5 class="modal-title">üìä Preview Ingredient Import</h5>
</div>
{% csrf_token %}
<div class="modal-body">
  {% if count_invalid %}
  <div class="alert alert-warning small">
    ‚ö†Ô∏è {{ count_invalid }} invalid rows detected. They will be skipped.
  </div>
  {% endif %}

  {% if valid_rows %}
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div><strong>{{ count_valid }}</strong> valid rows ready to import</div>
    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#validTable">
      üì¶ Show Valid Rows
    </button>
  </div>

  <div class="collapse {% if not collapse_valid %}show{% endif %}" id="validTable">
    <table class="table table-sm table-bordered mb-3">
      <thead class="table-light">
        <tr>
          <th>Action</th>
          <th>Name</th>
          <th>Type</th>
          <th>Unit</th>
          <th class="text-end">Case Size</th>
          <th class="text-end">Reorder Point</th>
          <th class="text-end">Avg Cost</th>
          <th class="text-end">Lead Time</th>
        </tr>
      </thead>
      <tbody>
        {% for row in valid_rows %}
        <tr>
          <td class="text-muted">{{ row.operation|capfirst }}</td>
          <td>{{ row.name }}</td>
          <td>{{ row.type_name|default:"‚Äì" }}</td>
          <td>{{ row.unit_type_name|default:"‚Äì" }}</td>
          <td class="text-end">{{ row.case_size|default:"‚Äì" }}</td>
          <td class="text-end">{{ row.reorder_point|default:"‚Äì" }}</td>
          <td class="text-end">{{ row.average_cost_per_unit|default:"‚Äì" }}</td>
          <td class="text-end">{{ row.lead_time|default:"‚Äì" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info small">No valid rows detected. Fix the errors below and retry.</div>
  {% endif %}

  {% if invalid_rows %}
  <div class="mt-3">
    <div class="alert alert-warning small mb-2">
      ‚ö†Ô∏è {{ count_invalid }} invalid rows detected. They will be skipped.
    </div>
    <div class="collapse show" id="invalidTable">
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr>
            <th class="text-nowrap">Line</th>
            <th>Name</th>
            <th>Type</th>
            <th>Unit</th>
            <th class="text-nowrap">Case Size</th>
            <th>Reorder</th>
            <th>Avg Cost</th>
            <th>Lead</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody>
          {% for row in invalid_rows %}
          <tr>
            <td>{{ row.line }}</td>
            <td>{{ row.name }}</td>
            <td>{{ row.type_name|default:row.type_id }}</td>
            <td>{{ row.unit_type_name|default:row.unit_type_id }}</td>
            <td>{{ row.case_size|default:"‚Äì" }}</td>
            <td>{{ row.reorder_point|default:"‚Äì" }}</td>
            <td>{{ row.average_cost_per_unit|default:"‚Äì" }}</td>
            <td>{{ row.lead_time|default:"‚Äì" }}</td>
            <td class="text-danger small">{{ row.error }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <textarea id="ingredientImportData" hidden>{{ valid_rows_json|safe }}</textarea>
  <div class="text-end mt-3">
    <button class="btn btn-success btn-sm" hx-post="{% url 'confirm_ingredients_import' %}" hx-vals='js:{
      csrfmiddlewaretoken: document.querySelector("[name=csrfmiddlewaretoken]").value,
      valid_rows: JSON.stringify(JSON.parse(document.getElementById("ingredientImportData").value || "[]"))
    }' hx-target="#globalModal .modal-content" hx-swap="innerHTML" {% if not count_valid %}disabled{% endif %}>
      Confirm Import
    </button>
  </div>
</div>
