<div class="modal-header">
  <h5 class="modal-title">Edit Modifier Rules</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
  <style>
    #globalModal .tall-select {
      min-height: 7em;
    }

    #globalModal .placeholder-option,
    #globalModal .form-select optgroup {
      font-size: smaller;
    }
  </style>

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div class="fw-semibold text-muted small">Manage modifier behaviors, targets, replacements, and expansions.</div>
    <button class="btn btn-outline-primary btn-sm"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#create-modifier-section"
            aria-expanded="{{ new_modifier_open|yesno:'true,false' }}"
            aria-controls="create-modifier-section">
      ‚ûï Create New Modifier
    </button>
  </div>

  <div class="collapse {% if new_modifier_open %}show{% endif %}" id="create-modifier-section">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <form id="create-modifier-form"
              class="row g-3"
              hx-post="{% url 'create_modifier' %}"
              hx-target="#globalModal .modal-content"
              hx-swap="outerHTML">
          {% csrf_token %}
          <div class="col-md-4">
            <label for="create-modifier-name" class="form-label">Name<span class="text-danger">*</span></label>
            <input type="text"
                   class="form-control{% if new_modifier_errors.name %} is-invalid{% endif %}"
                   id="create-modifier-name"
                   name="create_name"
                   value="{{ new_modifier_data.name|default:'' }}"
                   placeholder="e.g. Oat Milk">
            {% if new_modifier_errors.name %}
            <div class="invalid-feedback">{{ new_modifier_errors.name }}</div>
            {% endif %}
          </div>
          <div class="col-md-4">
            <label for="create-modifier-type" class="form-label">Type<span class="text-danger">*</span></label>
            <select class="form-select tall-select{% if new_modifier_errors.type %} is-invalid{% endif %}"
                    id="create-modifier-type"
                    name="create_type">
              <option value="" class="placeholder-option" {% if not new_modifier_data.type %}selected{% endif %} disabled>-- Select Type --</option>
              {% for value, label in modifier_type_choices %}
              <option value="{{ value }}" {% if new_modifier_data.type == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            {% if new_modifier_errors.type %}
            <div class="invalid-feedback">{{ new_modifier_errors.type }}</div>
            {% endif %}
          </div>
          <div class="col-md-4">
            <label for="create-modifier-ingredient" class="form-label">Ingredient<span class="text-danger">*</span></label>
            <select class="form-select tall-select{% if new_modifier_errors.ingredient %} is-invalid{% endif %}"
                    id="create-modifier-ingredient"
                    name="create_ingredient">
              <option value="" class="placeholder-option" {% if not new_modifier_data.ingredient %}selected{% endif %} disabled>-- Select Ingredient --</option>
              {% for ingredient in ingredients %}
              <option value="{{ ingredient.id }}" {% if new_modifier_data.ingredient == ingredient.id|stringformat:'s' %}selected{% endif %}>
                {{ ingredient.name }}{% if ingredient.type %} ({{ ingredient.type.name }}){% endif %}
              </option>
              {% endfor %}
            </select>
            {% if new_modifier_errors.ingredient %}
            <div class="invalid-feedback">{{ new_modifier_errors.ingredient }}</div>
            {% endif %}
          </div>
          <div class="col-md-3">
            <label for="create-modifier-base-quantity" class="form-label">Base Quantity<span class="text-danger">*</span></label>
            <input type="number"
                   step="0.01"
                   min="0"
                   class="form-control{% if new_modifier_errors.base_quantity %} is-invalid{% endif %}"
                   id="create-modifier-base-quantity"
                   name="create_base_quantity"
                   value="{{ new_modifier_data.base_quantity|default:'' }}">
            {% if new_modifier_errors.base_quantity %}
            <div class="invalid-feedback">{{ new_modifier_errors.base_quantity }}</div>
            {% endif %}
          </div>
          <div class="col-md-3">
            <label for="create-modifier-unit" class="form-label">Unit<span class="text-danger">*</span></label>
            <select class="form-select tall-select{% if new_modifier_errors.unit %} is-invalid{% endif %}"
                    id="create-modifier-unit"
                    name="create_unit">
              <option value="" class="placeholder-option" {% if not new_modifier_data.unit %}selected{% endif %} disabled>-- Select Unit --</option>
              {% for unit_type in unit_types %}
              <option value="{{ unit_type.id }}" {% if new_modifier_data.unit == unit_type.id|stringformat:'s' %}selected{% endif %}>
                {{ unit_type.name }}{% if unit_type.abbreviation %} ({{ unit_type.abbreviation }}){% endif %}
              </option>
              {% endfor %}
            </select>
            {% if new_modifier_errors.unit %}
            <div class="invalid-feedback">{{ new_modifier_errors.unit }}</div>
            {% endif %}
          </div>
          <div class="col-md-3">
            <label for="create-modifier-cost" class="form-label">Cost per Unit</label>
            <input type="number"
                   step="0.01"
                   min="0"
                   class="form-control{% if new_modifier_errors.cost_per_unit %} is-invalid{% endif %}"
                   id="create-modifier-cost"
                   name="create_cost_per_unit"
                   value="{{ new_modifier_data.cost_per_unit|default:'' }}">
            {% if new_modifier_errors.cost_per_unit %}
            <div class="invalid-feedback">{{ new_modifier_errors.cost_per_unit }}</div>
            {% endif %}
          </div>
          <div class="col-md-3">
            <label for="create-modifier-price" class="form-label">Price per Unit</label>
            <input type="number"
                   step="0.01"
                   min="0"
                   class="form-control{% if new_modifier_errors.price_per_unit %} is-invalid{% endif %}"
                   id="create-modifier-price"
                   name="create_price_per_unit"
                   value="{{ new_modifier_data.price_per_unit|default:'' }}">
            {% if new_modifier_errors.price_per_unit %}
            <div class="invalid-feedback">{{ new_modifier_errors.price_per_unit }}</div>
            {% endif %}
          </div>
          <div class="col-12 d-flex justify-content-end gap-2">
            <button type="button"
                    class="btn btn-outline-secondary"
                    data-bs-toggle="collapse"
                    data-bs-target="#create-modifier-section"
                    aria-controls="create-modifier-section">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Create Modifier</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <form id="modifier-rules-form"
        hx-post="{% url 'modifier_rules_modal' %}"
        hx-target="#globalModal .modal-content"
        hx-swap="outerHTML">
    {% csrf_token %}

    <div class="accordion" id="modifier-rules-accordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="modifier-basics-heading">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#modifier-basics" aria-expanded="true" aria-controls="modifier-basics">
            Modifier, Behavior &amp; Scale
          </button>
        </h2>
        <div id="modifier-basics" class="accordion-collapse collapse show" aria-labelledby="modifier-basics-heading">
          <div class="accordion-body">
            <div class="row g-3 align-items-start">
              <div class="col-lg-4">
                <label for="modifier-select" class="form-label">Modifier</label>
                <div class="bubble-select" data-bubble-root>
                  <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text">üîç</span>
                    <input type="text" class="form-control" data-bubble-search-input placeholder="Search modifiers‚Ä¶">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bubble-search-clear aria-label="Clear modifier search">‚úï</button>
                  </div>
                  <select class="form-select tall-select" id="modifier-select" required size="10">
                    <option value="" class="placeholder-option" disabled selected>-- Select Modifier --</option>
                    {% for group in modifier_groups %}
                    <optgroup label="{{ group.label }}">
                      {% for modifier in group.modifiers %}
                      <option value="{{ modifier.id }}" data-type="{{ group.code }}">{{ modifier.name }}</option>
                      {% endfor %}
                    </optgroup>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-text">Pick a modifier to edit its behavior, targets, and expansions.</div>
              </div>
              <div class="col-lg-8">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="behavior-select" class="form-label">Behavior</label>
                    <select class="form-select" id="behavior-select" name="behavior">
                      {% for value, label in behavior_choices %}
                      <option value="{{ value }}">{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="quantity-factor" class="form-label">Quantity Factor</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="quantity-factor" name="quantity_factor" placeholder="1.00">
                    <div class="form-text">Multiplier used for SCALE/ADD behaviors.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header" id="target-rules-heading">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#target-rules" aria-expanded="false" aria-controls="target-rules">
            Target Rules
          </button>
        </h2>
        <div id="target-rules" class="accordion-collapse collapse" aria-labelledby="target-rules-heading">
          <div class="accordion-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="target-by-type" class="form-label">By Ingredient Type</label>
                <div class="bubble-select" data-bubble-root>
                  <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text">üîç</span>
                    <input type="text" class="form-control" data-bubble-search-input placeholder="Search types‚Ä¶">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bubble-search-clear aria-label="Clear type search">‚úï</button>
                  </div>
                  <select class="form-select tall-select" id="target-by-type" name="target_by_type" multiple size="6">
                    {% for ing_type in ingredient_types %}
                    <option value="{{ ing_type.name }}">{{ ing_type.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-text">Modifiers apply to ingredients that match these types.</div>
              </div>
              <div class="col-md-6">
                <label for="target-by-name" class="form-label">By Ingredient Name</label>
                <div class="bubble-select" data-bubble-root>
                  <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text">üîç</span>
                    <input type="text" class="form-control" data-bubble-search-input placeholder="Search ingredients‚Ä¶">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bubble-search-clear aria-label="Clear ingredient search">‚úï</button>
                  </div>
                  <select class="form-select tall-select" id="target-by-name" name="target_by_name" multiple size="6">
                    {% for group in ingredient_groups %}
                    <optgroup label="{{ group.label }}">
                      {% for ingredient in group.ingredients %}
                      <option value="{{ ingredient.name }}" data-type="{{ group.code }}">{{ ingredient.name }}</option>
                      {% endfor %}
                    </optgroup>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-text">Use when only specific ingredients should be affected.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header" id="replacement-mapping-heading">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#replacement-mapping" aria-expanded="false" aria-controls="replacement-mapping">
            Replacement Mapping
          </button>
        </h2>
        <div id="replacement-mapping" class="accordion-collapse collapse" aria-labelledby="replacement-mapping-heading">
          <div class="accordion-body">
            <div id="replacement-container"></div>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="add-replacement-row">Add Replacement</button>
            <div class="form-text mt-2">Only used for REPLACE behavior. Define the ingredient and quantity that should replace the original.</div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header" id="expands-to-heading">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#expands-to" aria-expanded="false" aria-controls="expands-to">
            Expands To
          </button>
        </h2>
        <div id="expands-to" class="accordion-collapse collapse" aria-labelledby="expands-to-heading">
          <div class="accordion-body">
            <select class="form-select tall-select" id="expands-to-select" name="expands_to" multiple size="8">
              {% for modifier in modifiers %}
              <option value="{{ modifier.id }}">{{ modifier.name }} ({{ modifier.get_type_display }})</option>
              {% endfor %}
            </select>
            <div class="form-text">Choose additional modifiers that this rule expands into.</div>
          </div>
        </div>
      </div>
    </div>

    <input type="hidden" name="modifier_id" id="modifier-id-field">
  </form>
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  <button type="submit" class="btn btn-primary" id="save-modifier-rules" form="modifier-rules-form" disabled>Save Rules</button>
</div>

<template id="replacement-row-template">
  <div class="row g-2 align-items-start replacement-row mb-3">
    <div class="col">
      <div class="bubble-select" data-bubble-root>
        <div class="input-group input-group-sm mb-2">
          <span class="input-group-text">üîç</span>
          <input type="text" class="form-control" data-bubble-search-input placeholder="Search replacements‚Ä¶">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bubble-search-clear aria-label="Clear replacement search">‚úï</button>
        </div>
        <select class="form-select form-select-sm tall-select replacement-select" name="replacement_name" size="6">
          <option value="" class="placeholder-option">-- Select Ingredient --</option>
          {% for group in ingredient_groups %}
          <optgroup label="{{ group.label }}">
            {% for ingredient in group.ingredients %}
            <option value="{{ ingredient.name }}" data-type="{{ group.code }}">{{ ingredient.name }}</option>
            {% endfor %}
          </optgroup>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="col-3">
      <label class="visually-hidden">Quantity</label>
      <input type="number" step="0.01" class="form-control form-control-sm replacement-qty" name="replacement_qty" placeholder="Qty">
    </div>
    <div class="col-auto align-self-center">
      <button type="button" class="btn btn-outline-danger btn-sm remove-replacement" aria-label="Remove replacement">‚úï</button>
    </div>
  </div>
</template>

<script id="modifier-rules-data" type="application/json">{{ modifier_json|safe }}</script>
<script id="modifier-rules-meta" type="application/json">{{ modifier_meta|default:'{}'|safe }}</script>

<script>
  (function () {
    const globalModal = document.getElementById('globalModal');
    const dialog = globalModal?.querySelector('.modal-dialog');
    dialog?.classList.add('modal-xl', 'modal-dialog-scrollable');

    const modifierSelect = document.getElementById('modifier-select');
    const modifierIdField = document.getElementById('modifier-id-field');
    const behaviorSelect = document.getElementById('behavior-select');
    const quantityFactorInput = document.getElementById('quantity-factor');
    const targetByType = document.getElementById('target-by-type');
    const targetByName = document.getElementById('target-by-name');
    const replacementContainer = document.getElementById('replacement-container');
    const addReplacementBtn = document.getElementById('add-replacement-row');
    const expandSelect = document.getElementById('expands-to-select');
    const saveButton = document.getElementById('save-modifier-rules');
    const replacementTemplate = document.getElementById('replacement-row-template');

    const bubbleHandlers = [];

    function setupBubbleSearch(root) {
      if (!root || root.dataset.bubbleReady === 'true') return;
      const select = root.querySelector('select');
      const searchInput = root.querySelector('[data-bubble-search-input]');
      const clearBtn = root.querySelector('[data-bubble-search-clear]');
      if (!select || !searchInput) return;

      root.dataset.bubbleReady = 'true';

      function getOptions() {
        return Array.from(select.querySelectorAll('option'));
      }

      function getGroups() {
        return Array.from(select.querySelectorAll('optgroup'));
      }

      function ensureMeta() {
        getOptions().forEach((opt, idx) => {
          if (!opt.dataset.originalIndex) opt.dataset.originalIndex = idx;
          if (!opt.dataset.hiddenByType) opt.dataset.hiddenByType = 'false';
          if (!opt.dataset.hiddenBySearch) opt.dataset.hiddenBySearch = 'false';
        });
      }

      function updateVisibility(opt) {
        const hidden = opt.dataset.hiddenByType === 'true' || opt.dataset.hiddenBySearch === 'true';
        opt.hidden = hidden;
      }

      function updateGroupVisibility() {
        getGroups().forEach(group => {
          const hasVisible = Array.from(group.querySelectorAll('option')).some(opt => !opt.hidden);
          group.hidden = !hasVisible;
        });
      }

      function restoreOrder() {
        const groups = getGroups();
        if (groups.length) {
          groups.forEach(group => {
            const options = Array.from(group.querySelectorAll('option'));
            options
              .sort((a, b) => Number(a.dataset.originalIndex) - Number(b.dataset.originalIndex))
              .forEach(opt => group.appendChild(opt));
          });
        } else {
          Array.from(select.options)
            .sort((a, b) => Number(a.dataset.originalIndex) - Number(b.dataset.originalIndex))
            .forEach(opt => select.appendChild(opt));
        }
      }

      function applySearch() {
        ensureMeta();
        const term = searchInput.value.trim().toLowerCase();
        if (!term) {
          getOptions().forEach(opt => {
            opt.dataset.hiddenBySearch = 'false';
            updateVisibility(opt);
          });
          restoreOrder();
          updateGroupVisibility();
          return;
        }

        const groups = getGroups();
        const processOptions = options => {
          const matches = [];
          options.forEach(opt => {
            const text = opt.textContent.toLowerCase();
            const idx = text.indexOf(term);
            if (idx === -1) {
              opt.dataset.hiddenBySearch = 'true';
            } else {
              opt.dataset.hiddenBySearch = 'false';
              if (opt.dataset.hiddenByType !== 'true') {
                matches.push({ opt, score: idx });
              }
            }
            updateVisibility(opt);
          });
          matches.sort((a, b) => a.score - b.score);
          matches.forEach(item => item.opt.parentElement.appendChild(item.opt));
        };

        if (groups.length) {
          groups.forEach(group => processOptions(Array.from(group.querySelectorAll('option'))));
        } else {
          processOptions(Array.from(select.options));
        }
        updateGroupVisibility();
      }

      searchInput.addEventListener('input', applySearch);
      clearBtn?.addEventListener('click', () => {
        searchInput.value = '';
        applySearch();
      });

      root.addEventListener('bubble:refresh', applySearch);
      bubbleHandlers.push(applySearch);
      applySearch();
    }

    function refreshBubbleSearch() {
      bubbleHandlers.forEach(handler => handler());
    }

    document.querySelectorAll('[data-bubble-root]').forEach(setupBubbleSearch);

    const rawData = document.getElementById('modifier-rules-data');
    if (!rawData) return;
    const modifierData = JSON.parse(rawData.textContent);

    const metaTag = document.getElementById('modifier-rules-meta');
    const meta = metaTag ? JSON.parse(metaTag.textContent || '{}') : {};
    const preselectedId = meta.selected_id ? String(meta.selected_id) : null;

    function findModifier(id) {
      return modifierData.find((item) => String(item.id) === String(id));
    }

    function populateTarget(selectEl, values) {
      if (!selectEl) return;
      const set = new Set(values || []);
      Array.from(selectEl.options).forEach(opt => {
        opt.selected = set.has(opt.value);
      });
    }

    function clearReplacementRows() {
      replacementContainer.innerHTML = '';
    }

    function applyReplacementTypeFilter() {
      if (!targetByType) return;
      const selectedTypes = new Set(Array.from(targetByType.selectedOptions).map(opt => opt.value));
      const selects = replacementContainer.querySelectorAll('.replacement-select');
      selects.forEach(select => {
        Array.from(select.options).forEach(opt => {
          if (opt.value === '') return;
          const type = opt.dataset.type || '';
          const allow = selectedTypes.size === 0 || selectedTypes.has(type);
          opt.dataset.hiddenByType = allow ? 'false' : 'true';
        });

        const selected = select.selectedOptions[0];
        if (selected && selected.dataset.hiddenByType === 'true') {
          select.value = '';
        }
      });
      refreshBubbleSearch();
    }

    function createReplacementRow(entry) {
      if (!replacementTemplate) return;
      const fragment = replacementTemplate.content.cloneNode(true);
      replacementContainer.appendChild(fragment);
      const createdRow = replacementContainer.lastElementChild;
      const select = createdRow.querySelector('.replacement-select');
      const qtyInput = createdRow.querySelector('.replacement-qty');
      if (select && entry) {
        select.value = entry[0] ?? '';
      }
      if (qtyInput && entry) {
        qtyInput.value = entry[1] ?? '';
      }
      setupBubbleSearch(createdRow.querySelector('[data-bubble-root]'));
      applyReplacementTypeFilter();
      return createdRow;
    }

    function populateExpandsTo(values, currentId) {
      if (!expandSelect) return;
      const selected = new Set((values || []).map(String));
      Array.from(expandSelect.options).forEach(opt => {
        opt.selected = selected.has(opt.value);
        opt.disabled = opt.value === String(currentId);
      });
    }

    function populateForm(id) {
      const modifier = findModifier(id);
      if (!modifier) {
        modifierIdField.value = '';
        saveButton.disabled = true;
        return;
      }
      modifierIdField.value = modifier.id;
      behaviorSelect.value = modifier.behavior;
      quantityFactorInput.value = modifier.quantity_factor || '';

      populateTarget(targetByType, modifier.target_selector.by_type);
      populateTarget(targetByName, modifier.target_selector.by_name);

      clearReplacementRows();
      const replacements = modifier.replaces && modifier.replaces.to ? modifier.replaces.to : [];
      if (replacements.length) {
        replacements.forEach(entry => createReplacementRow(entry));
      } else {
        createReplacementRow();
      }

      populateExpandsTo(modifier.expands_to, modifier.id);
      saveButton.disabled = false;
      applyReplacementTypeFilter();
      refreshBubbleSearch();
    }

    modifierSelect?.addEventListener('change', (event) => {
      const value = event.target.value;
      if (value) {
        populateForm(value);
      } else {
        modifierIdField.value = '';
        saveButton.disabled = true;
        clearReplacementRows();
      }
    });

    addReplacementBtn?.addEventListener('click', () => {
      createReplacementRow();
    });

    replacementContainer?.addEventListener('click', (event) => {
      if (event.target.classList.contains('remove-replacement')) {
        const row = event.target.closest('.replacement-row');
        row?.remove();
      }
    });

    targetByType?.addEventListener('change', applyReplacementTypeFilter);

    if (modifierSelect) {
      if (preselectedId && findModifier(preselectedId)) {
        modifierSelect.value = preselectedId;
        populateForm(preselectedId);
      } else if (modifierSelect.options.length > 1) {
        const firstValue = modifierSelect.options[1].value;
        modifierSelect.value = firstValue;
        populateForm(firstValue);
      } else {
        saveButton.disabled = true;
      }
    }
  })();
</script>
