<div class="modal-header">
  <h5 class="modal-title">Edit Modifier Rules</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form id="modifier-rules-form"
      hx-post="{% url 'modifier_rules_modal' %}"
      hx-target="#globalModal .modal-content"
      hx-swap="outerHTML">
  {% csrf_token %}
  <div class="modal-body">
    <div class="row g-3">
      <div class="col-lg-4">
        <label for="modifier-select" class="form-label">Modifier</label>
        <select class="form-select" id="modifier-select" required>
          <option value="" disabled selected>-- Select Modifier --</option>
          {% for modifier in modifiers %}
          <option value="{{ modifier.id }}">{{ modifier.name }} ({{ modifier.get_type_display }})</option>
          {% endfor %}
        </select>
        <div class="form-text">Pick a modifier to edit its behavior, targets, and expansions.</div>
      </div>
      <div class="col-lg-8">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="behavior-select" class="form-label">Behavior</label>
            <select class="form-select" id="behavior-select" name="behavior">
              {% for value, label in behavior_choices %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="quantity-factor" class="form-label">Quantity Factor</label>
            <input type="number" step="0.01" min="0" class="form-control" id="quantity-factor" name="quantity_factor" placeholder="1.00">
            <div class="form-text">Multiplier used for SCALE/ADD behaviors.</div>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-4">

    <h6 class="mb-2">Target Rules</h6>
    <div class="row g-3">
      <div class="col-md-6">
        <label for="target-by-type" class="form-label">By Ingredient Type</label>
        <select class="form-select" id="target-by-type" name="target_by_type" multiple size="6">
          {% for ing_type in ingredient_types %}
          <option value="{{ ing_type.name }}">{{ ing_type.name }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Modifiers will apply to ingredients that match these types.</div>
      </div>
      <div class="col-md-6">
        <label for="target-by-name" class="form-label">By Ingredient Name</label>
        <select class="form-select" id="target-by-name" name="target_by_name" multiple size="6">
          {% for ingredient in ingredients %}
          <option value="{{ ingredient.name }}">{{ ingredient.name }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Use when only specific ingredients should be affected.</div>
      </div>
    </div>

    <hr class="my-4">

    <h6 class="mb-2">Replacement Mapping</h6>
    <div id="replacement-container"></div>
    <button type="button" class="btn btn-outline-secondary btn-sm" id="add-replacement-row">Add Replacement</button>
    <div class="form-text mt-2">Only used for REPLACE behavior. Define the ingredient name and quantity that should replace the original.</div>

    <datalist id="ingredient-name-options">
      {% for ingredient in ingredients %}
      <option value="{{ ingredient.name }}"></option>
      {% endfor %}
    </datalist>

    <hr class="my-4">

    <h6 class="mb-2">Expands To</h6>
    <select class="form-select" id="expands-to-select" name="expands_to" multiple size="8">
      {% for modifier in modifiers %}
      <option value="{{ modifier.id }}">{{ modifier.name }} ({{ modifier.get_type_display }})</option>
      {% endfor %}
    </select>
    <div class="form-text">Choose additional modifiers that this rule expands into.</div>

  </div>

  <div class="modal-footer">
    <input type="hidden" name="modifier_id" id="modifier-id-field">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
    <button type="submit" class="btn btn-primary" id="save-modifier-rules" disabled>Save Rules</button>
  </div>
</form>

<script id="modifier-rules-data" type="application/json">{{ modifier_json|safe }}</script>

<script>
  (function () {
    const modifierSelect = document.getElementById('modifier-select');
    const modifierIdField = document.getElementById('modifier-id-field');
    const behaviorSelect = document.getElementById('behavior-select');
    const quantityFactorInput = document.getElementById('quantity-factor');
    const targetByType = document.getElementById('target-by-type');
    const targetByName = document.getElementById('target-by-name');
    const replacementContainer = document.getElementById('replacement-container');
    const addReplacementBtn = document.getElementById('add-replacement-row');
    const expandSelect = document.getElementById('expands-to-select');
    const saveButton = document.getElementById('save-modifier-rules');

    const rawData = document.getElementById('modifier-rules-data');
    if (!rawData) return;
    const modifierData = JSON.parse(rawData.textContent);

    function findModifier(id) {
      return modifierData.find((item) => String(item.id) === String(id));
    }

    function clearSelections(selectEl) {
      Array.from(selectEl.options).forEach(opt => opt.selected = false);
    }

    function populateTarget(selectEl, values) {
      const set = new Set(values || []);
      Array.from(selectEl.options).forEach(opt => {
        opt.selected = set.has(opt.value);
      });
    }

    function createReplacementRow(entry) {
      const row = document.createElement('div');
      row.className = 'row g-2 align-items-center replacement-row mb-2';
      const nameValue = entry ? entry[0] : '';
      const qtyValue = entry ? entry[1] : '';
      row.innerHTML = `
        <div class="col">
          <input type="text" class="form-control form-control-sm" name="replacement_name" placeholder="Ingredient name" list="ingredient-name-options" value="${nameValue ?? ''}">
        </div>
        <div class="col-3">
          <input type="number" step="0.01" class="form-control form-control-sm" name="replacement_qty" placeholder="Qty" value="${qtyValue ?? ''}">
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-outline-danger btn-sm remove-replacement">âœ•</button>
        </div>`;
      replacementContainer.appendChild(row);
    }

    function clearReplacementRows() {
      replacementContainer.innerHTML = '';
    }

    function populateExpandsTo(values, currentId) {
      const selected = new Set((values || []).map(String));
      Array.from(expandSelect.options).forEach(opt => {
        opt.selected = selected.has(opt.value);
        opt.disabled = opt.value === String(currentId);
      });
    }

    function populateForm(id) {
      const modifier = findModifier(id);
      if (!modifier) return;
      modifierIdField.value = modifier.id;
      behaviorSelect.value = modifier.behavior;
      quantityFactorInput.value = modifier.quantity_factor || '';

      populateTarget(targetByType, modifier.target_selector.by_type);
      populateTarget(targetByName, modifier.target_selector.by_name);

      clearReplacementRows();
      const replacements = modifier.replaces && modifier.replaces.to ? modifier.replaces.to : [];
      if (replacements.length) {
        replacements.forEach(entry => createReplacementRow(entry));
      } else {
        createReplacementRow();
      }

      populateExpandsTo(modifier.expands_to, modifier.id);
      saveButton.disabled = false;
    }

    modifierSelect?.addEventListener('change', (event) => {
      populateForm(event.target.value);
    });

    addReplacementBtn?.addEventListener('click', () => {
      createReplacementRow();
    });

    replacementContainer?.addEventListener('click', (event) => {
      if (event.target.classList.contains('remove-replacement')) {
        const row = event.target.closest('.replacement-row');
        row?.remove();
      }
    });

    // Auto-load first modifier if present
    if (modifierSelect && modifierSelect.options.length > 1) {
      const firstValue = modifierSelect.options[1].value;
      modifierSelect.value = firstValue;
      populateForm(firstValue);
    }
  })();
</script>

