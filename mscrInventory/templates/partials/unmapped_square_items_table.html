<div id="unmapped-items-table" class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <div class="btn-group" role="group" aria-label="Filter unmapped items">
        {% for value, label, count in filter_options %}
          {% if page_obj %}
            <a
              href="?type={{ value }}{% if include_known %}&include_known=true{% endif %}"
              class="btn btn-sm {% if filter_type == value %}btn-primary{% else %}btn-outline-secondary{% endif %}"
            >
              {{ label }} <span class="badge bg-light text-dark ms-1">{{ count }}</span>
            </a>
          {% else %}
            <button
              type="button"
              class="btn btn-sm {% if filter_type == value %}btn-primary{% else %}btn-outline-secondary{% endif %}"
              hx-get="{% url 'imports_unmapped_items' %}?type={{ value }}{% if include_known %}&include_known=true{% endif %}"
              hx-target="#unmapped-items-table"
              hx-swap="outerHTML"
            >
              {{ label }} <span class="badge bg-light text-dark ms-1">{{ count }}</span>
            </button>
          {% endif %}
        {% endfor %}
      </div>
      <div class="d-flex align-items-center gap-2">
        <form
          hx-get="{% url 'imports_unmapped_items' %}"
          hx-target="#unmapped-items-table"
          hx-swap="outerHTML"
          hx-trigger="change"
          class="d-flex align-items-center gap-2"
        >
          <input type="hidden" name="type" value="{{ filter_type }}">
          <input type="hidden" name="include_known" value="false">
          <div class="form-check form-switch mb-0">
            <input
              class="form-check-input"
              type="checkbox"
              role="switch"
              id="toggle-known-recipes"
              name="include_known"
              value="true"
              onchange="var bulkInclude=document.getElementById('bulk-include-known'); if(bulkInclude){bulkInclude.value=this.checked ? 'true' : 'false';}"
              {% if include_known %}checked{% endif %}
            >
            <label class="form-check-label" for="toggle-known-recipes">Show known recipes</label>
          </div>
        </form>
        {% if known_recipe_count %}
          <small class="text-muted text-nowrap">
            {% if include_known %}
              Showing {{ known_recipe_count }} known recipe{{ known_recipe_count|pluralize }}
            {% else %}
              Hiding {{ known_recipe_count }} known recipe{{ known_recipe_count|pluralize }}
            {% endif %}
          </small>
        {% endif %}
      </div>
      {% if total_unresolved %}
        <span class="badge bg-warning text-dark">{{ total_unresolved }} pending</span>
      {% endif %}
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Source</th>
            <th>Type</th>
            <th>Raw Name</th>
            <th class="text-nowrap">First Seen</th>
            <th class="text-nowrap">Last Seen</th>
            <th class="text-center">Occurrences</th>
            <th class="w-25">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in square_entries %}
            {% with item=entry.item link_form=entry.link_form create_form=entry.create_form %}
            <tr>
              <td>{{ item.get_source_display }}</td>
              <td>{{ item.get_item_type_display }}</td>
              <td>
                <div class="fw-semibold">{{ item.display_label }}</div>
                {% if item.is_known_recipe %}
                  <span class="badge bg-info text-dark small">Known recipe</span>
                {% endif %}
                {% if item.last_reason %}
                  <div class="text-muted small">Reason: {{ item.last_reason|title }}</div>
                {% endif %}
                {% if item.last_modifiers %}
                  <div class="text-muted small">Latest modifiers: {{ item.last_modifiers|join:", " }}</div>
                {% endif %}
              </td>
              <td class="text-muted small">{{ item.first_seen|date:"Y-m-d H:i" }}</td>
              <td class="text-muted small">{{ item.last_seen|date:"Y-m-d H:i" }}</td>
              <td class="text-center">{{ item.seen_count }}</td>
              <td>
                <div class="d-flex flex-column gap-2">
                  <button
                    class="btn btn-sm btn-outline-primary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#link-form-{{ item.id }}"
                    aria-expanded="false"
                    aria-controls="link-form-{{ item.id }}"
                  >
                    Link to Existing
                  </button>
                  <button
                    class="btn btn-sm btn-outline-success"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#create-form-{{ item.id }}"
                    aria-expanded="false"
                    aria-controls="create-form-{{ item.id }}"
                  >
                    Create New
                  </button>
                  <form
                    method="post"
                    action="{% url 'imports_unmapped_ignore' item.id %}"
                    class="d-inline"
                    hx-post="{% url 'imports_unmapped_ignore' item.id %}"
                    hx-target="#unmapped-items-table"
                    hx-swap="outerHTML"
                  >
                    {% csrf_token %}
                    <input type="hidden" name="filter_type" value="{{ filter_type }}">
                    <input type="hidden" name="include_known" value="{{ include_known|yesno:'true,false' }}">
                    {% if page_obj %}
                      <input type="hidden" name="paginate" value="1">
                      <input type="hidden" name="page" value="{{ page_obj.number }}">
                    {% endif %}
                    <button class="btn btn-sm btn-outline-warning w-100" type="submit">
                      Mark as Ignored
                    </button>
                  </form>
                </div>
                <div class="collapse mt-2" id="link-form-{{ item.id }}">
                  <div class="card card-body border-primary">
                    <form
                      method="post"
                      action="{% url 'imports_unmapped_link' item.id %}"
                      hx-post="{% url 'imports_unmapped_link' item.id %}"
                      hx-target="#unmapped-items-table"
                      hx-swap="outerHTML"
                      class="row gy-2 align-items-end"
                    >
                      {% csrf_token %}
                      {{ link_form.filter_type }}
                      <input type="hidden" name="include_known" value="{{ include_known|yesno:'true,false' }}">
                      {% if page_obj %}
                        <input type="hidden" name="paginate" value="1">
                        <input type="hidden" name="page" value="{{ page_obj.number }}">
                      {% else %}
                        <input type="hidden" name="paginate" value="0">
                      {% endif %}
                      <div class="col-12">
                        {{ link_form.target.label_tag }}
                        {{ link_form.target }}
                        {% if link_form.target.errors %}
                          <div class="invalid-feedback d-block">{{ link_form.target.errors|join:", " }}</div>
                        {% endif %}
                      </div>
                      {% if link_form.non_field_errors %}
                        <div class="col-12 text-danger small">{{ link_form.non_field_errors|join:", " }}</div>
                      {% endif %}
                      <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-sm">Save Link</button>
                      </div>
                    </form>
                  </div>
                </div>
                <div class="collapse mt-2" id="create-form-{{ item.id }}">
                  <div class="card card-body border-success">
                    <form
                      method="post"
                      action="{% url 'imports_unmapped_create' item.id %}"
                      hx-post="{% url 'imports_unmapped_create' item.id %}"
                      hx-target="#unmapped-items-table"
                      hx-swap="outerHTML"
                      class="row gy-2"
                    >
                      {% csrf_token %}
                      {{ create_form.filter_type }}
                      <input type="hidden" name="include_known" value="{{ include_known|yesno:'true,false' }}">
                      {% if page_obj %}
                        <input type="hidden" name="paginate" value="1">
                        <input type="hidden" name="page" value="{{ page_obj.number }}">
                      {% else %}
                        <input type="hidden" name="paginate" value="0">
                      {% endif %}
                      {% for field in create_form %}
                        {% if field.name != 'filter_type' %}
                          <div class="col-12">
                            {{ field.label_tag }}
                            {{ field }}
                            {% if field.errors %}
                              <div class="invalid-feedback d-block">{{ field.errors|join:", " }}</div>
                            {% endif %}
                          </div>
                        {% endif %}
                      {% endfor %}
                      {% if create_form.non_field_errors %}
                        <div class="col-12 text-danger small">{{ create_form.non_field_errors|join:", " }}</div>
                      {% endif %}
                      <div class="col-12">
                        <button type="submit" class="btn btn-success btn-sm">Create &amp; Link</button>
                      </div>
                    </form>
                  </div>
                </div>
              </td>
            </tr>
            {% endwith %}
          {% empty %}
            <tr>
              <td colspan="7" class="text-success text-center py-4">âœ… All Square items are mapped.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj %}
      <nav class="mt-3" aria-label="Unmapped pagination">
        <ul class="pagination pagination-sm mb-0">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?type={{ filter_type }}&page={{ page_obj.previous_page_number }}{% if include_known %}&include_known=true{% endif %}">Previous</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}
          {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
              <a class="page-link" href="?type={{ filter_type }}&page={{ num }}{% if include_known %}&include_known=true{% endif %}">{{ num }}</a>
            </li>
          {% endfor %}
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?type={{ filter_type }}&page={{ page_obj.next_page_number }}{% if include_known %}&include_known=true{% endif %}">Next</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  </div>
</div>
