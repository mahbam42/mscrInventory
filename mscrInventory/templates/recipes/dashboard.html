{% extends "base.html" %}
{% block title %}Recipes{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">â˜• Recipe Dashboard</h2>
  <hr />
  <!-- Edit Widgets -->
  <div class="d-flex justify-content-end flex-wrap gap-2 mb-3">
    {% if perms.mscrInventory.change_product %}
    <button class="btn btn-sm btn-outline-secondary" hx-get="{% url 'recipes_create_product' %}"
      hx-target="#globalModal .modal-content" hx-swap="innerHTML">
      â• Create Product
    </button>
    {% endif %}

    {% if perms.mscrInventory.change_recipemodifier %}
    <button class="btn btn-sm btn-outline-success"
      hx-get="{% url 'modifier_rules_modal' %}"
      hx-target="#globalModal .modal-content"
      hx-swap="innerHTML">
      ğŸ› ï¸ Edit Modifier Rules
    </button>
    {% endif %}

    {% if perms.mscrInventory.view_recipeitem %}
    <a href="{% url 'export_recipes_csv' %}" class="btn btn-sm btn-outline-secondary">
      ğŸ“¤ Export Recipes CSV
    </a>
    {% endif %}

    {% if perms.mscrInventory.change_recipeitem %}
    <button hx-get="{% url 'import_recipes_modal' %}" hx-target="#globalModal .modal-content" hx-swap="innerHTML"
      class="btn btn-sm btn-outline-primary">
      ğŸ“¥ Import Recipes CSV
    </button>
    {% endif %}
  </div>

  {% include "partials/_tools.html" with show_inventory_tools=False %}
  <hr />
  <!-- Category Filter -->
<div class="d-flex align-items-start flex-wrap gap-2 mb-3">

  <!-- ğŸ” Search field -->
  <div class="d-flex align-items-start gap-2">
    <input type="text" id="recipe-search" class="form-control form-control-sm"
      placeholder="Search recipes or categoriesâ€¦" style="width: 250px;">
    <button type="button" id="recipe-clear" class="btn btn-outline-secondary btn-sm" title="Clear search">
      âœ•
    </button>
  </div>

  <!-- ğŸ“‹ Show All -->
  <button class="btn btn-sm {% if selected_category == "" %}btn-primary{% else %}btn-outline-primary{% endif %}"
          hx-get="/recipes/" hx-target="#recipes-table-wrap" hx-swap="innerHTML">
    Show All
  </button>

  <button class="btn btn-sm {% if selected_category == "none" %}btn-primary{% else %}btn-outline-secondary{% endif %} category-btn"
          hx-get="/recipes/"
          hx-target="#recipes-table-wrap"
          hx-swap="innerHTML"
          hx-vals='{"category": "none"}'>
    No Categories
  </button>

  <!-- ğŸ—‚ Category buttons -->
  {% for cat in categories %}
  {% if cat.categories__id %}
  {% with cat.categories__id|stringformat:'s' as cat_id %}
  <button class="btn btn-sm {% if selected_category == cat_id %}btn-primary{% else %}btn-outline-secondary{% endif %} category-btn"
          hx-get="/recipes/"
          hx-target="#recipes-table-wrap"
          hx-swap="innerHTML"
          hx-vals='{"category": "{{ cat.categories__id }}"}'>
    {{ cat.categories__name }}
  </button>
  {% endwith %}
  {% endif %}
  {% endfor %}
</div>

  <!-- Recipes Table -->
  <div id="recipes-table-wrap"
    hx-get="{% url 'recipes_table_fragment' %}{% if selected_category %}?category={{ selected_category }}{% endif %}"
    hx-trigger="load, recipes:refresh from:body" 
    hx-target="this" 
    hx-swap="innerHTML">
    {% include "recipes/_table.html" with products=products %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const search = document.getElementById("recipe-search");
    const clear = document.getElementById("recipe-clear");

    let timeout;

    function triggerSearch() {
      const query = search.value.trim();
      const url = query ? `/recipes/?q=${encodeURIComponent(query)}` : "/recipes/";
      htmx.ajax("GET", url, { target: "#recipes-table-wrap", swap: "innerHTML" });
    }

    if (search) {
      search.addEventListener("input", () => {
        clearTimeout(timeout);
        timeout = setTimeout(triggerSearch, 300);
      });
    }

    if (clear) {
      clear.addEventListener("click", () => {
        search.value = "";
        triggerSearch();
      });
    }
  });
</script>
{% endblock %}
