<div class="modal-header">
  <h5 class="modal-title">Edit Recipe: {{ product.name }}</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
  <form id="recipe-form" hx-post="{% url 'edit_recipe' product.id %}" hx-target="#modal-body" hx-swap="outerHTML">
    {% csrf_token %}

    <h6>Ingredients</h6>
    <table class="table table-sm" id="ingredient-table">
      <thead>
        <tr>
          <th>Ingredient</th>
          <th>Quantity</th>
          <th>Unit</th>
          <th>Cost</th>
          <th>Price</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for ri in ingredients %}
        <tr>
          <td>{{ ri.ingredient.name }}</td>
          <td><input type="number" step="0.01" name="quantity_{{ forloop.counter0 }}" value="{{ ri.quantity }}" class="form-control form-control-sm"></td>
          <td><input type="text" name="unit_{{ forloop.counter0 }}" value="{{ ri.unit }}" class="form-control form-control-sm"></td>
          <td><input type="number" step="0.01" name="cost_{{ forloop.counter0 }}" value="{{ ri.cost_per_unit }}" class="form-control form-control-sm"></td>
          <td><input type="number" step="0.01" name="price_{{ forloop.counter0 }}" value="{{ ri.price_per_unit }}" class="form-control form-control-sm"></td>
          <td><button type="button" class="btn btn-sm btn-danger remove-row">Ã—</button></td>
          <input type="hidden" name="ingredient_id_{{ forloop.counter0 }}" value="{{ ri.ingredient.id }}">
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="button" class="btn btn-secondary btn-sm" id="add-ingredient">+ Add Ingredient</button>

    <hr>

    <h6>Modifiers</h6>
    {% for type, mods in modifiers_by_type.items %}
      <div class="mb-2">
        <strong>{{ type }}</strong><br>
        {% for mod in mods %}
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="modifiers" value="{{ mod.id }}"
                   {% if mod.id in current_modifiers %}checked{% endif %}>
            <label class="form-check-label">{{ mod.name }}</label>
          </div>
        {% endfor %}
      </div>
    {% endfor %}

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="submit" class="btn btn-primary">Save Recipe</button>
    </div>

  </form>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const tbody = document.querySelector('#ingredient-table tbody');
  const addBtn = document.getElementById('add-ingredient');

  function nextIndex() {
    const names = Array.from(document.querySelectorAll('[name^="ingredient_name_"],[name^="ingredient_id_"]'))
      .map(el => (el.name.match(/_(\d+)$/) || [null, -1])[1])
      .map(n => parseInt(n, 10))
      .filter(n => !isNaN(n));
    return names.length ? Math.max(...names) + 1 : 0;
  }

  function createRow(index) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="text" name="ingredient_name_${index}" class="form-control form-control-sm" placeholder="Ingredient name">
        <input type="hidden" name="ingredient_id_${index}" value="">
      </td>
      <td><input type="number" step="0.01" name="quantity_${index}" class="form-control form-control-sm" placeholder="0.00"></td>
      <td><input type="text" name="unit_${index}" class="form-control form-control-sm" placeholder="oz"></td>
      <td><input type="number" step="0.01" name="cost_${index}" class="form-control form-control-sm" placeholder="0.00"></td>
      <td><input type="number" step="0.01" name="price_${index}" class="form-control form-control-sm" placeholder="0.00"></td>
      <td><button type="button" class="btn btn-sm btn-danger remove-row">&times;</button></td>
    `;
    return tr;
  }

  addBtn.addEventListener('click', () => {
    const idx = nextIndex();
    tbody.appendChild(createRow(idx));
  });

  tbody.addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-row')) {
      e.target.closest('tr').remove();
    }
  });
});
</script>
