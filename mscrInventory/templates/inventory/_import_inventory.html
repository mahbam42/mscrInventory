<div class="modal-header">
    <h5 class="modal-title">Import Inventory</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
    {% csrf_token %}

    {% if stage == "upload" %}
    {% if error %}
    <div class="alert alert-warning" role="alert">
        {{ error }}
    </div>
    {% endif %}

    <form hx-post="{% url 'import_inventory_csv' %}" hx-target="#globalModal .modal-content" hx-swap="innerHTML"
        enctype="multipart/form-data" class="d-flex flex-column gap-3">
        <div>
            <label class="form-label">Select CSV File</label>
            <input type="file" name="file" accept=".csv" class="form-control" required>
        </div>

        {% if required_headers %}
        <p class="text-muted small mb-0">
            Upload a CSV with columns:
            {% for header in required_headers %}
            <code>{{ header }}</code>{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </p>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center">
            <a href="{% url 'download_inventory_csv_template' %}" class="btn btn-sm btn-outline-secondary">
                üìÑ Download Template
            </a>
            <button class="btn btn-primary btn-sm" type="submit">Preview</button>
        </div>
    </form>

    {% elif valid_rows %}
    <div class="alert alert-info mb-2">
        ‚úÖ {{ valid_count }} valid row{{ valid_count|pluralize }} ready to import.
        {% if invalid_count %}
        <br>‚ö†Ô∏è {{ invalid_count }} invalid row{{ invalid_count|pluralize }} skipped.
        {% endif %}
    </div>

    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
        <table class="table table-sm table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Qty (added)</th>
                    <th>Current Stock</th>
                    <th>Cost/Unit</th>
                    <th>Case Size</th>
                    <th>Lead Time</th>
                </tr>
            </thead>
            <tbody>
                {% for r in valid_rows %}
                <tr>
                    <td>{{ r.ingredient }}</td>
                    <td>{{ r.name }}</td>
                    <td>{{ r.quantity_added }}</td>
                    <td>{{ r.current_stock|default:"‚Äî" }}</td>
                    <td>{{ r.cost_per_unit }}</td>
                    <td>{{ r.case_size }}</td>
                    <td>{{ r.lead_time }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-outline-secondary btn-sm" hx-get="{% url 'import_inventory_modal' %}"
            hx-target="#globalModal .modal-content" hx-swap="innerHTML">
            ‚¨ÖÔ∏è Back
        </button>
        <button id="confirmImportBtn" class="btn btn-success btn-sm">
            ‚úÖ Confirm Import
        </button>
    </div>
</div> 

{{ valid_rows|json_script:"validRowsData" }}
<script>
    const validRows = JSON.parse(document.getElementById("validRowsData").textContent);
    document.getElementById("confirmImportBtn").addEventListener("click", () => {
        fetch("{% url 'confirm_inventory_import' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify(validRows),
        })
            .then(res => res.json())
            .then(() => {
                htmx.trigger(document.body, "inventory:refresh");
                bootstrap.Modal.getInstance(document.getElementById("globalModal")).hide();
            });
    });
</script>
{% endif %}