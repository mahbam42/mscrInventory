<div class="modal-header">
    <h5 class="modal-title">ðŸ“¦ Bulk Add Stock</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
    <!-- âœ… this is the only inner target HTMX touches -->
    <div id="bulk-modal-content">
        <form hx-post="{% url 'bulk_add_stock' %}" hx-target="#bulk-modal-content" hx-swap="innerHTML"
            class="row g-2 align-items-start mb-3">
            {% csrf_token %}

            <table class="table table-sm table-bordered align-middle mb-3" id="bulk-stock-table">
                <thead class="table-light">
                    <tr>
                        <th>Ingredient</th>
                        <th>Qty</th>
                        <th>Cost</th>
                        <th>Case</th>
                        <th>Lead Time</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="bulk-stock-body"></tbody>
            </table>

            <div class="col-6">
                <label class="form-label">Ingredient</label>
                <input type="text" id="ingredient-search" class="form-control form-control-sm mb-1"
                    placeholder="Search ingredientsâ€¦" style="display:inline; width:85%;">
                <button type="button" id="ingredient-clear" class="btn btn-outline-secondary"
                    title="Clear search">âœ•</button>

                <select name="ingredient" id="bulk-ingredient-select" class="form-select form-select-sm" size="8">
                    {% regroup all_ingredients by type as ingredients_by_type %}
                    {% for group in ingredients_by_type %}
                    <optgroup label="{{ group.grouper|title }}">
                        {% for ing in group.list %}
                        <option value="{{ ing.id }}">{{ ing.name }}</option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>

            <div class="col-3">
                <label class="form-label">Qty Added</label>
                <input type="number" step="0.01" name="quantity_added" class="form-control form-control-sm"
                    placeholder="0">
                <label class="form-label mt-2">Case Size</label>
                <input type="number" step="1" name="case_size" class="form-control form-control-sm"
                    placeholder="Units per case">
            </div>

            <div class="col-3">
                <label class="form-label">Cost / Unit</label>
                <input type="number" step="0.0001" name="cost_per_unit" class="form-control form-control-sm"
                    placeholder="0.00">
                <label class="form-label mt-2">Lead Time (days)</label>
                <input type="number" step="1" name="lead_time" class="form-control form-control-sm" placeholder="0">
            </div>

            <div class="col-12 mt-3 text-end">
                <button type="button" id="add-row" class="btn btn-outline-secondary">âž• Add another</button>
                <button type="submit" class="btn btn-primary">ðŸ’¾ Save All</button>
            </div>
        </form>
    </div>
</div>

<script>
    function initBulkAddModal() {
        const modalBody = document.getElementById("modal-body");
        const addRowBtn = modalBody.querySelector("#add-row");
        const tbody = modalBody.querySelector("#bulk-stock-body");
        const form = modalBody.querySelector("form");
        const ingredientSelect = modalBody.querySelector("#bulk-ingredient-select");
        const searchInput = modalBody.querySelector("#ingredient-search");
        const clearButton = modalBody.querySelector("#ingredient-clear");

        if (!form || !ingredientSelect) return;

        // --- Ingredient Search Filter ---
        if (searchInput && clearButton) {
            const filterIngredients = () => {
                const term = searchInput.value.toLowerCase();
                ingredientSelect.querySelectorAll("optgroup").forEach(group => {
                    let anyVisible = false;
                    group.querySelectorAll("option").forEach(opt => {
                        const name = opt.textContent.toLowerCase();
                        const isExtra = ["extra", "dirty chai", "drizzle cup"].some(p => name.includes(p));
                        const visible = !isExtra && (term === "" || name.includes(term));
                        opt.style.display = visible ? "" : "none";
                        if (visible) anyVisible = true;
                    });
                    group.style.display = anyVisible ? "" : "none";
                });
            };
            searchInput.oninput = filterIngredients;
            clearButton.onclick = () => { searchInput.value = ""; filterIngredients(); };
            filterIngredients(); // initial run (hides "extras")
        }

        // --- Add Another Row ---
        if (addRowBtn && tbody) {
            addRowBtn.onclick = (event) => {
                event.preventDefault();
                const ingId = ingredientSelect.value;
                const ingName = ingredientSelect.options[ingredientSelect.selectedIndex]?.text || "(No name)";
                const qty = form.querySelector("[name='quantity_added']").value;
                const cost = form.querySelector("[name='cost_per_unit']").value;
                const caseSize = form.querySelector("[name='case_size']").value;
                const leadTime = form.querySelector("[name='lead_time']").value;
                if (!ingId || !qty || !cost) return;

                const row = document.createElement("tr");
                row.innerHTML = `
        <td>${ingName}<input type="hidden" name="ingredient" value="${ingId}"></td>
        <td>${qty}<input type="hidden" name="quantity_added" value="${qty}"></td>
        <td>${cost}<input type="hidden" name="cost_per_unit" value="${cost}"></td>
        <td>${caseSize || "-"}<input type="hidden" name="case_size" value="${caseSize}"></td>
        <td>${leadTime || "-"}<input type="hidden" name="lead_time" value="${leadTime}"></td>
        <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger remove-row">âœ•</button></td>`;
                tbody.appendChild(row);
                form.reset();
                filterIngredients(); // reapply filter after reset
            };
        }

        // --- Remove Row ---
        modalBody.addEventListener("click", (e) => {
            if (e.target.classList.contains("remove-row")) e.target.closest("tr")?.remove();
        });
    }

    // Run both on first HTMX load and on modal open
    document.body.addEventListener("htmx:afterSwap", (e) => {
        if (e.target.id === "modal-body") initBulkAddModal();
    });
    document.addEventListener("shown.bs.modal", (e) => {
        if (e.target.id === "globalModal") initBulkAddModal();
    });

    // Listen for modal close â†’ trigger inventory refresh
    /* document.addEventListener("hidden.bs.modal", (event) => {
        if (event.target.id === "globalModal") {
            console.log("ðŸ“¦ Modal closed â€” refreshing inventory");
            htmx.trigger(document.body, "inventory:refresh");
        }
    }); */
</script>