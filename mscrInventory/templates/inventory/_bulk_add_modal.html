<div class="modal-header">
    <h5 class="modal-title">üì¶ Bulk Add Stock</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
    <!-- ‚úÖ this is the only inner target HTMX touches -->
    <div id="bulk-modal-content">
        <form hx-post="{% url 'bulk_add_stock' %}" hx-target="#bulk-modal-content" hx-swap="innerHTML"
            class="row g-2 align-items-start mb-3">
            {% csrf_token %}

            <table class="table table-sm table-bordered align-middle mb-3" id="bulk-stock-table">
                <thead class="table-light">
                    <tr>
                        <th>Ingredient</th>
                        <th>Qty</th>
                        <th>Cost</th>
                        <th>Case</th>
                        <th>Lead Time</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="bulk-stock-body"></tbody>
            </table>

            <div class="col-6">
                <label class="form-label">Ingredient</label>
                <input type="text" id="ingredient-search" class="form-control form-control-sm mb-1"
                    placeholder="Search ingredients‚Ä¶" style="display:inline; width:85%;">
                <button type="button" id="ingredient-clear" class="btn btn-outline-secondary"
                    title="Clear search">‚úï</button>

                <select name="ingredient" id="bulk-ingredient-select" class="form-select form-select-sm" size="8">
                    {% regroup all_ingredients by type as ingredients_by_type %}
                    {% for group in ingredients_by_type %}
                    <optgroup label="{{ group.grouper|title }}">
                        {% for ing in group.list %}
                        <option value="{{ ing.id }}">{{ ing.name }}</option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>

            <div class="col-3">
                <label class="form-label">Qty Added</label>
                <input type="number" step="0.01" name="quantity_added" class="form-control form-control-sm"
                    placeholder="0">
                <label class="form-label mt-2">Case Size</label>
                <input type="number" step="1" name="case_size" class="form-control form-control-sm"
                    placeholder="Units per case">
            </div>

            <div class="col-3">
                <label class="form-label">Cost / Unit</label>
                <input type="number" step="0.0001" name="cost_per_unit" class="form-control form-control-sm"
                    placeholder="0.00">
                <label class="form-label mt-2">Lead Time (days)</label>
                <input type="number" step="1" name="lead_time" class="form-control form-control-sm" placeholder="0">
            </div>

            <div class="col-12 mt-3 text-end">
                <button type="button" id="add-row" class="btn btn-outline-secondary">‚ûï Add another</button>
                <button type="submit" class="btn btn-primary">üíæ Save All</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("shown.bs.modal", (event) => {
        const modal = event.target;
        if (modal.id === "globalModal" && modal.querySelector("#bulk-ingredient-select")) {
            console.log("‚úÖ Bulk Add Modal fully shown");
            initBulkAddModal();
        }
    });

    function initBulkAddModal() {
        const searchInput = document.getElementById("ingredient-search");
        const clearButton = document.getElementById("ingredient-clear");
        const ingredientSelect = document.getElementById("bulk-ingredient-select");
        const addRowBtn = document.getElementById("add-row");
        const form = document.querySelector("#bulk-modal-inner form");
        const modalBody = document.querySelector(".modal-body");

        if (searchInput && ingredientSelect) {
            searchInput.addEventListener("input", () => {
                const term = searchInput.value.toLowerCase();
                ingredientSelect.querySelectorAll("optgroup").forEach(group => {
                    let anyVisible = false;
                    group.querySelectorAll("option").forEach(opt => {
                        const name = opt.textContent.toLowerCase();
                        const isExtra = ["extra", "dirty chai", "drizzle cup"].some(p => name.includes(p));
                        const visible = !isExtra && (term === "" || name.includes(term));
                        opt.style.display = visible ? "" : "none";
                        if (visible) anyVisible = true;
                    });
                    group.style.display = anyVisible ? "" : "none";
                });
            });
            clearButton.addEventListener("click", () => {
                searchInput.value = "";
                searchInput.dispatchEvent(new Event("input"));
            });
            searchInput.dispatchEvent(new Event("input"));
        }

        if (addRowBtn && form) {
            addRowBtn.addEventListener("click", () => {
                console.log("‚ûï Add Another clicked");
                const ingSelect = form.querySelector("[name='ingredient']");
                const ingId = ingSelect.value;
                const ingName = ingSelect.options[ingSelect.selectedIndex]?.text || "(No name)";
                const qty = form.querySelector("[name='quantity_added']").value;
                const cost = form.querySelector("[name='cost_per_unit']").value;
                const caseSize = form.querySelector("[name='case_size']").value;
                const leadTime = form.querySelector("[name='lead_time']").value;
                if (!ingId || !qty || !cost) {
                    alert("Please fill in Ingredient, Quantity, and Cost.");
                    return;
                }
                const tbody = document.getElementById("bulk-stock-body");
                const row = document.createElement("tr");
                row.innerHTML = `
        <td>${ingName}<input type="hidden" name="ingredient" value="${ingId}"></td>
        <td>${qty}<input type="hidden" name="quantity_added" value="${qty}"></td>
        <td>${cost}<input type="hidden" name="cost_per_unit" value="${cost}"></td>
        <td>${caseSize || "-"}<input type="hidden" name="case_size" value="${caseSize}"></td>
        <td>${leadTime || "-"}<input type="hidden" name="lead_time" value="${leadTime}"></td>
        <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger remove-row">‚úï</button></td>`;
                tbody.appendChild(row);
                form.reset();
            });
        }

        modalBody.addEventListener("click", (e) => {
            if (e.target.classList.contains("remove-row")) {
                e.target.closest("tr").remove();
                console.log("üóëÔ∏è Row removed");
            }
        });
    }
</script>