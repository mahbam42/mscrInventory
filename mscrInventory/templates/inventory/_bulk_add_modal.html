<div class="modal-header">
    <h5 class="modal-title">ðŸ“¦ Bulk Add Stock</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
    <!-- âœ… this is the only inner target HTMX touches -->
    <div id="bulk-modal-content">
        <form hx-post="{% url 'bulk_add_stock' %}" hx-target="#bulk-modal-content" hx-swap="innerHTML"
            class="row g-2 align-items-start mb-3">
            {% csrf_token %}

            <!-- Transaction context (applies to all rows) -->
            <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                <label for="reason" class="form-label mb-0">Reason:</label>
                <select name="reason" id="reason" class="form-select form-select-sm w-auto">
                    <option value="Restock">Restock</option>
                    <option value="Correction">Correction</option>
                    <option value="Spoilage">Spoilage</option>
                    <option value="Manual Adjustment">Manual Adjustment</option>
                </select>
            
                <input type="text" name="note" class="form-control form-control-sm flex-grow-1" placeholder="Optional note..." />
            </div>

            <table class="table table-sm table-bordered align-middle mb-3" id="bulk-stock-table">
                <thead class="table-light">
                    <tr>
                        <th>Ingredient</th>
                        <th>Qty</th>
                        <th>Unit</th>
                        <th>Cost</th>
                        <th>Case</th>
                        <th>Lead Time</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="bulk-stock-body"></tbody>
            </table>

            <div class="col-6">
                <label class="form-label">Ingredient</label>
                <input type="text" id="ingredient-search" class="form-control form-control-sm mb-1"
                    placeholder="Search ingredientsâ€¦" style="display:inline; width:85%;">
                <button type="button" id="ingredient-clear" class="btn btn-outline-secondary"
                    title="Clear search">âœ•</button>

                <select name="ingredient" id="bulk-ingredient-select" class="form-select form-select-sm" size="8">
                    {% regroup all_ingredients by type as ingredients_by_type %}
                    {% for group in ingredients_by_type %}
                    <optgroup label="{{ group.grouper|title }}">
                        {% for ing in group.list %}
                        <option value="{{ ing.id }}" data-unit="{{ ing.unit_type.id|default:'' }}">
                            {{ ing.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>

            <div class="col-3">
                <label class="form-label">Qty Added</label>
                <div class="d-flex gap-2">
                    <input type="number" step="any" name="Modalquantity_added" class="form-control form-control-sm"
                        placeholder="0">
                    <select name="Modalunit_type" class="form-select form-select-sm" style="max-width: 110px;">
                        <option value="">Unit</option>
                        {% for unit in unit_types %}
                        <option value="{{ unit.id }}">{{ unit.abbreviation|default:unit.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <label class="form-label mt-2">Case Size</label>
                <input type="number" step="1" name="Modalcase_size" class="form-control form-control-sm"
                    placeholder="Units per case">
            </div>

            <div class="col-3">
                <label class="form-label">Cost / Unit</label>
                <input type="number" step="0.0001" name="Modalcost_per_unit" class="form-control form-control-sm"
                    placeholder="0.00">
                <label class="form-label mt-2">Lead Time (days)</label>
                <input type="number" step="1" name="Modallead_time" class="form-control form-control-sm" placeholder="0">
            </div>

            <div class="col-12 mt-3 text-end">
                <button type="button" id="add-row" class="btn btn-outline-secondary">âž• Add another</button>
                <button type="submit" class="btn btn-primary">ðŸ’¾ Save All</button>
            </div>
        </form>
    </div>
</div>

<script>
    function initBulkAddModal() {
        const modalBody = document.getElementById("modal-body");
        const addRowBtn = modalBody.querySelector("#add-row");
        const tbody = modalBody.querySelector("#bulk-stock-body");
        const form = modalBody.querySelector("form");
        const ingredientSelect = modalBody.querySelector("#bulk-ingredient-select");
        const unitSelect = modalBody.querySelector("[name='Modalunit_type']");
        const searchInput = modalBody.querySelector("#ingredient-search");
        const clearButton = modalBody.querySelector("#ingredient-clear");

        if (!form || !ingredientSelect) return;

        // --- Ingredient Search Filter ---
        if (searchInput && clearButton) {
            const filterIngredients = () => {
                const term = searchInput.value.toLowerCase();
                ingredientSelect.querySelectorAll("optgroup").forEach(group => {
                    let anyVisible = false;
                    group.querySelectorAll("option").forEach(opt => {
                        const name = opt.textContent.toLowerCase();
                        const isExtra = ["extra", "dirty chai", "drizzle cup"].some(p => name.includes(p));
                        const visible = !isExtra && (term === "" || name.includes(term));
                        opt.style.display = visible ? "" : "none";
                        if (visible) anyVisible = true;
                    });
                    group.style.display = anyVisible ? "" : "none";
                });
            };
            searchInput.oninput = filterIngredients;
            clearButton.onclick = () => { searchInput.value = ""; filterIngredients(); };
            filterIngredients(); // initial run (hides "extras")
        }

        // --- Add Another Row ---
        if (addRowBtn && tbody) {
            addRowBtn.onclick = (event) => {
                event.preventDefault();
                const ingId = ingredientSelect.value;
                const ingName = ingredientSelect.options[ingredientSelect.selectedIndex]?.text || "(No name)";
                const qty = form.querySelector("[name='Modalquantity_added']").value;
                const cost = form.querySelector("[name='Modalcost_per_unit']").value;
                const caseSize = form.querySelector("[name='Modalcase_size']").value;
                const leadTime = form.querySelector("[name='Modallead_time']").value;
                const unitSelect = form.querySelector("[name='Modalunit_type']");
                const unitId = unitSelect?.value || "";
                const unitLabel = unitSelect?.options[unitSelect.selectedIndex]?.text || "";

                if (!ingId || !qty || !cost) return;

                const row = document.createElement("tr");
                row.innerHTML = `
        <td>${ingName}<input type="hidden" name="ingredient" value="${ingId}"></td>
        <td>${qty}<input type="hidden" name="Rowquantity_added" value="${qty}"></td>
        <td>${unitLabel || ""}<input type="hidden" name="Rowunit_type" value="${unitId}"></td>
        <td>${cost}<input type="hidden" name="Rowcost_per_unit" value="${cost}"></td>
        <td>${caseSize || "-"}<input type="hidden" name="Rowcase_size" value="${caseSize}"></td>
        <td>${leadTime || "-"}<input type="hidden" name="Rowlead_time" value="${leadTime}"></td>
        <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger remove-row">âœ•</button></td>`;
                tbody.appendChild(row);
                form.reset();
                filterIngredients(); // reapply filter after reset
            };
        }

        // --- Remove Row ---
        modalBody.addEventListener("click", (e) => {
            if (e.target.classList.contains("remove-row")) e.target.closest("tr")?.remove();
        });
    }

    // Run both on first HTMX load and on modal open
    document.body.addEventListener("htmx:afterSwap", (e) => {
        if (e.target.id === "modal-body") initBulkAddModal();
    });
    document.addEventListener("shown.bs.modal", (e) => {
        if (e.target.id === "globalModal") initBulkAddModal();
    });


    // --- Auto-fill fields when ingredient selected ---
    const ingredientSelect = document.getElementById("bulk-ingredient-select");
    const unitSelect = document.querySelector("[name='Modalunit_type']");
    if (ingredientSelect) {
        ingredientSelect.addEventListener("change", async (e) => {
            const ingId = e.target.value;
            if (!ingId) return;
            const defaultUnit = e.target.options[e.target.selectedIndex]?.dataset.unit;
            if (unitSelect && defaultUnit !== undefined) {
                unitSelect.value = defaultUnit;
            }
            try {
                console.log("ðŸ“¦ Fetching details for ingredient ID:", ingId);

                const res = await fetch(`/inventory/ingredient/${ingId}/details/`);
                if (!res.ok) {
                    console.warn("âš ï¸ Ingredient details fetch failed:", res.status);
                    return;
                }

                const data = await res.json();
                console.log("âœ… Ingredient autofill data:", data);

                // Populate modal fields with data
                document.querySelector("[name='Modalcase_size']").value = data.case_size || "";
                document.querySelector("[name='Modallead_time']").value = data.lead_time || "";
                document.querySelector("[name='Modalcost_per_unit']").value = data.average_cost_per_unit || "";
            } catch (err) {
                console.error("Error fetching ingredient details:", err);
            }
        });
    }
    /* // --- Auto-fill fields when ingredient selected ---
    const ingredientSelect = document.getElementById("bulk-ingredient-select");
    if (ingredientSelect) {
        ingredientSelect.addEventListener("change", async (e) => {
            const ingId = e.target.value;
            if (!ingId) return;
            console.log("ðŸ“¦ Fetching details for ingredient ID:", ingId);
            try {
                const res = await fetch(`/inventory/ingredient/${ingId}/details/`);
                if (!res.ok) return;
                const data = await res.json();

                caseInput.value = data.case_size ?? "";
                leadInput.value = data.lead_time ?? "";
                costInput.value = data.average_cost_per_unit ?? "";
            } catch (err) {
                console.error("Error fetching ingredient details:", err);
            }
        }); 
    } */

    // Listen for modal close â†’ trigger inventory refresh
    /* document.addEventListener("hidden.bs.modal", (event) => {
        if (event.target.id === "globalModal") {
            console.log("ðŸ“¦ Modal closed â€” refreshing inventory");
            htmx.trigger(document.body, "inventory:refresh");
        }
    }); */
</script>