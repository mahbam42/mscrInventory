<div class="card h-100">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Top Selling Products</span>
    <button class="btn btn-sm btn-outline-secondary collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-top-products" aria-expanded="true" aria-controls="collapse-top-products">
      <span class="label-expanded">Collapse</span>
      <span class="label-collapsed">Expand</span>
    </button>
  </div>
  <div id="collapse-top-products" class="collapse show">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm mb-0 sortable-table align-middle">
          <thead>
            <tr>
              <th class="text-nowrap" data-sort-type="number">Rank</th>
              <th>Product</th>
              <th>Descriptors</th>
              <th>Modifiers</th>
              <th class="text-end" data-sort-type="number">Quantity</th>
              <th class="text-end" data-sort-type="number">Gross Sales</th>
              <th class="text-end" data-sort-type="number">Change</th>
            </tr>
          </thead>
          <tbody>
            {% for row in top_products %}
            <tr>
              <td class="text-nowrap">
                <span class="badge bg-primary-subtle text-primary">#{{ row.rank|default:forloop.counter }}</span>
              </td>
              <td>
                {{ row.product_name }}
                {% if row.variant_count and row.variant_count > 0 %}
                  {% with counter=forloop.counter0|stringformat:"s" %}
                    {% with script_id="variant-details-"|add:counter %}
                      <button type="button"
                              class="btn btn-link btn-sm p-0 variant-details-trigger"
                              data-variant-script-id="{{ script_id }}"
                              data-product-name="{{ row.product_name }}">
                        Includes {{ row.variant_count }} variant{% if row.variant_count|pluralize %}s{% endif %}
                      </button>
                      {{ row.variant_details|json_script:script_id }}
                    {% endwith %}
                  {% endwith %}
                {% endif %}
              </td>
              <td>
                {% if row.adjectives %}
                  {{ row.adjectives|join:", " }}
                {% else %}—{% endif %}
                {% if row.suppressed_descriptors %}
                  <div class="text-muted small">Also includes: {{ row.suppressed_descriptors|join:", " }}</div>
                {% endif %}
              </td>
              <td>
                {% if row.modifiers %}
                  {% with modifiers=row.modifiers %}
                    {% with modifier_count=modifiers|length %}
                      {% with truncated=modifiers|slice:":5" %}
                        <div class="modifier-list" data-modifier-count="{{ modifier_count }}">
                          <span class="modifier-visible">{{ truncated|join:", " }}</span>
                          {% if modifier_count > 5 %}
                            <span class="modifier-full d-none">{{ modifiers|join:", " }}</span>
                            <button type="button" class="btn btn-link btn-sm p-0 modifier-toggle" aria-expanded="false">
                              Show all ({{ modifier_count }})
                            </button>
                          {% endif %}
                        </div>
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}
                {% else %}—{% endif %}
              </td>
              <td class="text-end">{{ row.quantity|floatformat:0 }}</td>
              <td class="text-end">${{ row.gross_sales|floatformat:2 }}</td>
              <td class="text-end">
                {% with delta=row.rank_delta %}
                  {% if delta is not None %}
                    {% if delta > 0 %}
                      <span class="badge bg-success-subtle text-success">▲ {{ delta }}</span>
                    {% elif delta < 0 %}
                  <span class="badge bg-danger-subtle text-danger">▼ {{ delta|floatformat:"0"|cut:"-" }}</span>
                    {% else %}
                      <span class="badge bg-secondary-subtle text-secondary">—</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">n/a</span>
                  {% endif %}
                {% endwith %}
              </td>
            </tr>
            {% empty %}
            <tr class="table-placeholder"><td colspan="7" class="text-center text-muted">No sales recorded.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
