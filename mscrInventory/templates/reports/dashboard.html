{% extends "base.html" %}
{% block title %}Reporting Dashboard · MSCR Inventory{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">Reporting Dashboard</h1>
  <form method="get" class="row g-2 align-items-end">
    <div class="col-auto">
      <label for="id_start" class="form-label">Start Date</label>
      <input type="date" id="id_start" name="start" class="form-control" value="{{ start|date:'Y-m-d' }}" />
    </div>
    <div class="col-auto">
      <label for="id_end" class="form-label">End Date</label>
      <input type="date" id="id_end" name="end" class="form-control" value="{{ end|date:'Y-m-d' }}" />
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Apply</button>
    </div>
  </form>
</div>

{% include "partials/_tools.html" with show_inventory_tools=False %}

<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase fw-semibold">Revenue</h6>
        <p class="display-6">${{ total_revenue|floatformat:2 }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase fw-semibold">COGS</h6>
        <p class="display-6">${{ total_cogs|floatformat:2 }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase fw-semibold">Profit</h6>
        <p class="display-6">${{ profitability.overall_profit|default:0|floatformat:2 }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase fw-semibold">Margin</h6>
        {% if profitability.overall_margin_pct %}
          <p class="display-6">{{ profitability.overall_margin_pct }}%</p>
        {% else %}
          <p class="display-6">—</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header">COGS Trend ({{ tzname }})</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Date</th>
                <th class="text-end">COGS</th>
                <th class="text-end">Variance</th>
                <th class="text-end">Variance %</th>
              </tr>
            </thead>
            <tbody>
              {% for row in trend %}
              <tr>
                <td>{{ row.date }}</td>
                <td class="text-end">${{ row.cogs_total|floatformat:2 }}</td>
                <td class="text-end">
                  {% if row.variance is not None %}
                    ${{ row.variance|floatformat:2 }}
                  {% else %}—{% endif %}
                </td>
                <td class="text-end">
                  {% if row.variance_pct is not None %}
                    {{ row.variance_pct }}%
                  {% else %}—{% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-center text-muted">No data for selected range.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header">Ingredient Usage Totals</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Ingredient</th>
                <th class="text-end">Quantity Used</th>
              </tr>
            </thead>
            <tbody>
              {% for ingredient, qty in usage_totals %}
              <tr>
                <td>{{ ingredient }}</td>
                <td class="text-end">{{ qty|floatformat:3 }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="2" class="text-center text-muted">No usage logged.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header">Top Selling Products</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Product</th>
                <th>Descriptors</th>
                <th>Modifiers</th>
                <th class="text-end">Quantity</th>
                <th class="text-end">Gross Sales</th>
              </tr>
            </thead>
            <tbody>
              {% for row in top_products %}
              <tr>
                <td>{{ row.product_name }}</td>
                <td>
                  {% if row.adjectives %}
                    {{ row.adjectives|join:", " }}
                  {% else %}—{% endif %}
                </td>
                <td>
                  {% if row.modifiers %}
                    {{ row.modifiers|join:", " }}
                  {% else %}—{% endif %}
                </td>
                <td class="text-end">{{ row.quantity|floatformat:0 }}</td>
                <td class="text-end">${{ row.gross_sales|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted">No sales recorded.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header">Top Modifiers</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Modifier</th>
                <th class="text-end">Quantity</th>
                <th class="text-end">Gross Sales</th>
              </tr>
            </thead>
            <tbody>
              {% for row in top_modifiers %}
              <tr>
                <td>{{ row.modifier }}</td>
                <td class="text-end">{{ row.quantity|floatformat:0 }}</td>
                <td class="text-end">${{ row.gross_sales|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="3" class="text-center text-muted">No modifiers detected.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">Per-Product COGS Summary</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-sm mb-0">
        <thead>
          <tr>
            <th>Product</th>
            <th>SKU</th>
            <th class="text-end">Quantity</th>
            <th class="text-end">Revenue</th>
            <th class="text-end">COGS</th>
            <th class="text-end">Profit</th>
            <th class="text-end">Margin %</th>
          </tr>
        </thead>
        <tbody>
          {% for row in product_summary %}
          <tr>
            <td>{{ row.product_name }}</td>
            <td>{{ row.sku }}</td>
            <td class="text-end">{{ row.quantity|floatformat:0 }}</td>
            <td class="text-end">${{ row.revenue|floatformat:2 }}</td>
            <td class="text-end">${{ row.cogs|floatformat:2 }}</td>
            <td class="text-end">${{ row.profit|floatformat:2 }}</td>
            <td class="text-end">
              {% if row.margin_pct %}
                {{ row.margin_pct }}%
              {% else %}—{% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="text-center text-muted">No orders in range.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">Per-Category Profitability</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-sm mb-0">
        <thead>
          <tr>
            <th>Category</th>
            <th class="text-end">Quantity</th>
            <th class="text-end">Revenue</th>
            <th class="text-end">COGS</th>
            <th class="text-end">Profit</th>
            <th class="text-end">Margin %</th>
          </tr>
        </thead>
        <tbody>
          {% for row in category_summary %}
          <tr>
            <td>{{ row.category }}</td>
            <td class="text-end">{{ row.quantity|floatformat:0 }}</td>
            <td class="text-end">${{ row.revenue|floatformat:2 }}</td>
            <td class="text-end">${{ row.cogs|floatformat:2 }}</td>
            <td class="text-end">${{ row.profit|floatformat:2 }}</td>
            <td class="text-end">
              {% if row.margin_pct %}
                {{ row.margin_pct }}%
              {% else %}—{% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="text-center text-muted">No category data.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">Ingredient Usage Log</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>Ingredient</th>
            <th class="text-end">Quantity</th>
            <th>Source</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in usage_logs %}
          <tr>
            <td>{{ entry.date }}</td>
            <td>{{ entry.ingredient.name }}</td>
            <td class="text-end">{{ entry.quantity_used|floatformat:3 }}</td>
            <td>{{ entry.get_source_display }}</td>
            <td>{{ entry.note|default:"—" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-center text-muted">No usage entries.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if linkage.missing_cost_ingredients %}
<div class="alert alert-warning">
  <strong>Cost data missing for:</strong>
  {{ linkage.missing_cost_ingredients|join:", " }}. Update ingredient pricing to improve COGS accuracy.
</div>
{% endif %}

{% endblock %}
