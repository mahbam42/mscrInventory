{% extends "base.html" %}
{% block title %}Reporting Dashboard Â· MSCR Inventory{% endblock %}

{% block content %}
  <div id="reporting">
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-3">ðŸ“ˆ Reporting Dashboard</h2>
  <form method="get" class="row g-2 align-items-end">
    <div class="col-auto">
      <label for="id_start" class="form-label">Start Date</label>
      <input type="date" id="id_start" name="start" class="form-control" value="{{ start|date:'Y-m-d' }}" />
    </div>
    <div class="col-auto">
      <label for="id_end" class="form-label">End Date</label>
      <input type="date" id="id_end" name="end" class="form-control" value="{{ end|date:'Y-m-d' }}" />
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Apply</button>
    </div>
  </form>
</div>

{% include "partials/_tools.html" with show_inventory_tools=False %}
<hr />
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase fw-semibold">Revenue</h6>
        <p class="display-6">${{ total_revenue|floatformat:2 }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase fw-semibold">COGS</h6>
        <p class="display-6">${{ total_cogs|floatformat:2 }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase fw-semibold">Profit</h6>
        <p class="display-6">${{ profitability.overall_profit|default:0|floatformat:2 }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase fw-semibold">Margin</h6>
        {% if profitability.overall_margin_pct %}
          <p class="display-6">{{ profitability.overall_margin_pct }}%</p>
        {% else %}
          <p class="display-6">â€”</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Top Selling Products</span>
        <button class="btn btn-sm btn-outline-secondary collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-top-products" aria-expanded="true" aria-controls="collapse-top-products">
          <span class="label-expanded">Collapse</span>
          <span class="label-collapsed">Expand</span>
        </button>
      </div>
      <div id="collapse-top-products" class="collapse show">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0 sortable-table">
              <thead>
                <tr>
                <th>Product</th>
                <th>Descriptors</th>
                <th>Modifiers</th>
                <th class="text-end" data-sort-type="number">Quantity</th>
                <th class="text-end" data-sort-type="number">Gross Sales</th>
              </tr>
              </thead>
            <tbody>
              {% for row in top_products %}
              <tr>
                <td>
                  {{ row.product_name }}
                  {% if row.variant_count and row.variant_count > 0 %}
                    {% with counter=forloop.counter0|stringformat:"s" %}
                      {% with script_id="variant-details-"|add:counter %}
                        <button type="button"
                                class="btn btn-link btn-sm p-0 variant-details-trigger"
                                data-variant-script-id="{{ script_id }}"
                                data-product-name="{{ row.product_name }}">
                          Includes {{ row.variant_count }} variant{% if row.variant_count|pluralize %}s{% endif %}
                        </button>
                        {{ row.variant_details|json_script:script_id }}
                      {% endwith %}
                    {% endwith %}
                  {% endif %}
                </td>
                <td>
                  {% if row.adjectives %}
                    {{ row.adjectives|join:", " }}
                  {% else %}â€”{% endif %}
                  {% if row.suppressed_descriptors %}
                    <div class="text-muted small">Also includes: {{ row.suppressed_descriptors|join:", " }}</div>
                  {% endif %}
                </td>
                <td>
                  {% if row.modifiers %}
                    {{ row.modifiers|join:", " }}
                  {% else %}â€”{% endif %}
                </td>
                <td class="text-end">{{ row.quantity|floatformat:0 }}</td>
                <td class="text-end">${{ row.gross_sales|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr class="table-placeholder"><td colspan="5" class="text-center text-muted">No sales recorded.</td></tr>
              {% endfor %}
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Top Modifiers</span>
        <button class="btn btn-sm btn-outline-secondary collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-top-modifiers" aria-expanded="true" aria-controls="collapse-top-modifiers">
          <span class="label-expanded">Collapse</span>
          <span class="label-collapsed">Expand</span>
        </button>
      </div>
      <div id="collapse-top-modifiers" class="collapse show">
        <div class="card-body p-0">
          <div class="table-responsive">
          <table class="table table-sm mb-0 sortable-table">
            <thead>
              <tr>
                <th>Modifier</th>
                <th>Unit</th>
                <th class="text-end" data-sort-type="number">Quantity</th>
                <th class="text-end" data-sort-type="number">Gross Sales</th>
              </tr>
            </thead>
            <tbody>
              {% for row in top_modifiers %}
              <tr>
                <td>
                  {{ row.modifier }}
                  {% if row.original_label and row.original_label|lower != row.modifier|lower %}
                    <div class="text-muted small">Token: {{ row.original_label }}</div>
                  {% endif %}
                </td>
                <td>{% if row.unit %}{{ row.unit }}{% else %}â€”{% endif %}</td>
                <td class="text-end">{{ row.quantity|floatformat:0 }}</td>
                <td class="text-end">${{ row.gross_sales|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr class="table-placeholder"><td colspan="4" class="text-center text-muted">No modifiers detected.</td></tr>
              {% endfor %}
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>COGS Trend</span>
        <button class="btn btn-sm btn-outline-secondary collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-cogs-trend" aria-expanded="true" aria-controls="collapse-cogs-trend">
          <span class="label-expanded">Collapse</span>
          <span class="label-collapsed">Expand</span>
        </button>
      </div>
      <div id="collapse-cogs-trend" class="collapse show">
        <div class="card-body p-0">
          <div class="table-responsive">
          <table class="table table-sm mb-0 sortable-table">
            <thead>
              <tr>
                <th data-sort-type="date">Date</th>
                <th class="text-end" data-sort-type="number">COGS</th>
                <th class="text-end" data-sort-type="number">Variance</th>
                <th class="text-end" data-sort-type="number">Variance %</th>
              </tr>
            </thead>
            <tbody>
              {% for row in trend %}
              <tr>
                <td{% if row.date_obj %} data-order="{{ row.date_obj|date:'U' }}"{% endif %}>
                  {% if row.date_obj %}
                    {{ row.date_obj|date:"Y-m-d" }}
                  {% else %}
                    {{ row.date }}
                  {% endif %}
                </td>
                <td class="text-end">${{ row.cogs_total|floatformat:2 }}</td>
                <td class="text-end">
                  {% if row.variance is not None %}
                  ${{ row.variance|floatformat:2 }}
                  {% else %}â€”{% endif %}
                </td>
                <td class="text-end">
                  {% if row.variance_pct is not None %}
                  {{ row.variance_pct }}%
                  {% else %}â€”{% endif %}
                </td>
              </tr>
              {% empty %}
              <tr class="table-placeholder">
                <td colspan="4" class="text-center text-muted">No data for selected range.</td>
              </tr>
              {% endfor %}
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Ingredient Usage Totals</span>
        <button class="btn btn-sm btn-outline-secondary collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-usage-totals" aria-expanded="true" aria-controls="collapse-usage-totals">
          <span class="label-expanded">Collapse</span>
          <span class="label-collapsed">Expand</span>
        </button>
      </div>
      <div id="collapse-usage-totals" class="collapse show">
        <div class="card-body p-0">
          <div class="table-responsive">
          <table class="table table-sm mb-0 sortable-table">
            <thead>
              <tr>
                <th>Ingredient</th>
                <th class="text-end" data-sort-type="number">Quantity Used</th>
              </tr>
            </thead>
            <tbody>
              {% for ingredient, qty in usage_totals %}
              <tr>
                <td>{{ ingredient }}</td>
                <td class="text-end">{{ qty|floatformat:3 }}</td>
              </tr>
              {% empty %}
              <tr class="table-placeholder">
                <td colspan="2" class="text-center text-muted">No usage logged.</td>
              </tr>
              {% endfor %}
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Per-Product COGS Summary</span>
    <button class="btn btn-sm btn-outline-secondary collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-product-summary" aria-expanded="true" aria-controls="collapse-product-summary">
      <span class="label-expanded">Collapse</span>
      <span class="label-collapsed">Expand</span>
    </button>
  </div>
  <div id="collapse-product-summary" class="collapse show">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-sm mb-0 sortable-table">
          <thead>
            <tr>
            <th>Product</th>
            <th>SKU</th>
            <th class="text-end" data-sort-type="number">Quantity</th>
            <th class="text-end" data-sort-type="number">Revenue</th>
            <th class="text-end" data-sort-type="number">COGS</th>
            <th class="text-end" data-sort-type="number">Profit</th>
            <th class="text-end" data-sort-type="number">Margin %</th>
          </tr>
        </thead>
        <tbody>
          {% for row in product_summary %}
          <tr>
            <td>{{ row.product_name }}</td>
            <td>{{ row.sku }}</td>
            <td class="text-end">{{ row.quantity|floatformat:"-2" }}</td>
            <td class="text-end">${{ row.revenue|floatformat:2 }}</td>
            <td class="text-end">${{ row.cogs|floatformat:2 }}</td>
            <td class="text-end">${{ row.profit|floatformat:2 }}</td>
            <td class="text-end">
              {% if row.margin_pct %}
                {{ row.margin_pct }}%
              {% else %}â€”{% endif %}
            </td>
          </tr>
          {% empty %}
          <tr class="table-placeholder"><td colspan="7" class="text-center text-muted">No orders in range.</td></tr>
          {% endfor %}
        </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Per-Category Profitability</span>
    <button class="btn btn-sm btn-outline-secondary collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-category-summary" aria-expanded="true" aria-controls="collapse-category-summary">
      <span class="label-expanded">Collapse</span>
      <span class="label-collapsed">Expand</span>
    </button>
  </div>
  <div id="collapse-category-summary" class="collapse show">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-sm mb-0 sortable-table">
          <thead>
            <tr>
            <th>Category</th>
            <th class="text-end" data-sort-type="number">Quantity</th>
            <th class="text-end" data-sort-type="number">Revenue</th>
            <th class="text-end" data-sort-type="number">COGS</th>
            <th class="text-end" data-sort-type="number">Profit</th>
            <th class="text-end" data-sort-type="number">Margin %</th>
          </tr>
        </thead>
        <tbody>
          {% for row in category_summary %}
          <tr>
            <td>{{ row.category }}</td>
            <td class="text-end">{{ row.quantity|floatformat:0 }}</td>
            <td class="text-end">${{ row.revenue|floatformat:2 }}</td>
            <td class="text-end">${{ row.cogs|floatformat:2 }}</td>
            <td class="text-end">${{ row.profit|floatformat:2 }}</td>
            <td class="text-end">
              {% if row.margin_pct %}
                {{ row.margin_pct }}%
              {% else %}â€”{% endif %}
            </td>
          </tr>
          {% empty %}
          <tr class="table-placeholder"><td colspan="6" class="text-center text-muted">No category data.</td></tr>
          {% endfor %}
        </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Ingredient Usage Log</span>
    <button class="btn btn-sm btn-outline-secondary collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-usage-log" aria-expanded="true" aria-controls="collapse-usage-log">
      <span class="label-expanded">Collapse</span>
      <span class="label-collapsed">Expand</span>
    </button>
  </div>
  <div id="collapse-usage-log" class="collapse show">
    <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 sortable-table">
        <thead>
          <tr>
            <th data-sort-type="date">Date</th>
            <th>Ingredient</th>
            <th class="text-end" data-sort-type="number">Quantity</th>
            <th>Source</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in usage_logs %}
          <tr>
            <td data-order="{{ entry.date|date:'U' }}">{{ entry.date }}</td>
            <td>{{ entry.ingredient.name }}</td>
            <td class="text-end">{{ entry.quantity_used|floatformat:3 }}</td>
            <td>{{ entry.get_source_display }}</td>
            <td>{{ entry.note|default:"â€”" }}</td>
          </tr>
          {% empty %}
          <tr class="table-placeholder"><td colspan="5" class="text-center text-muted">No usage entries.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="variantDetailsModal" tabindex="-1" aria-labelledby="variantDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="variantDetailsModalLabel">Variant Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="variant-details-body"></div>
      </div>
    </div>
  </div>
</div>

{% if linkage.missing_cost_ingredients %}
<div class="alert alert-warning">
  <strong>Cost data missing for:</strong>
  {{ linkage.missing_cost_ingredients|join:", " }}. Update ingredient pricing to improve COGS accuracy.
</div>
{% endif %}

  </div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    document.addEventListener('click', function (event) {
      const trigger = event.target.closest('.variant-details-trigger');
      if (!trigger) {
        return;
      }

      const scriptId = trigger.getAttribute('data-variant-script-id');
      const scriptEl = scriptId ? document.getElementById(scriptId) : null;
      if (!scriptEl) {
        return;
      }

      let variants;
      try {
        variants = JSON.parse(scriptEl.textContent || '[]');
      } catch (err) {
        console.error('Unable to parse variant payload', err);
        variants = [];
      }

      const modalEl = document.getElementById('variantDetailsModal');
      if (!modalEl) {
        return;
      }

      const title = modalEl.querySelector('.modal-title');
      if (title) {
        const productName = trigger.getAttribute('data-product-name') || 'Variants';
        title.textContent = `${productName} â€“ Variants`;
      }

      const body = modalEl.querySelector('.variant-details-body');
      if (body) {
        if (!variants.length) {
          body.innerHTML = '<p class="text-muted mb-0">No variant details recorded.</p>';
        } else {
          const rows = variants.map((variant) => {
            const adjectives = Array.isArray(variant.adjectives) && variant.adjectives.length
              ? variant.adjectives.join(', ')
              : 'â€”';
            const modifiers = Array.isArray(variant.modifiers) && variant.modifiers.length
              ? variant.modifiers.join(', ')
              : 'â€”';
            const suppressed = Array.isArray(variant.suppressed_descriptors) && variant.suppressed_descriptors.length
              ? `<div class="text-muted small">Also includes: ${variant.suppressed_descriptors.join(', ')}</div>`
              : '';
            const quantity = typeof variant.quantity === 'number' ? variant.quantity : parseFloat(variant.quantity || '0');
            const gross = typeof variant.gross_sales === 'number' ? variant.gross_sales : parseFloat(variant.gross_sales || '0');

            return `
              <tr>
                <td>
                  <div><strong>Descriptors:</strong> ${adjectives}</div>
                  <div><strong>Modifiers:</strong> ${modifiers}</div>
                  ${suppressed}
                </td>
                <td class="text-end">${Number.isFinite(quantity) ? quantity.toLocaleString(undefined, { maximumFractionDigits: 2 }) : 'â€”'}</td>
                <td class="text-end">${Number.isFinite(gross) ? '$' + gross.toFixed(2) : 'â€”'}</td>
              </tr>
            `;
          }).join('');

          body.innerHTML = `
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th scope="col">Variant</th>
                    <th scope="col" class="text-end">Quantity</th>
                    <th scope="col" class="text-end">Gross Sales</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
        }
      }

      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
    });
  </script>
  <script>
    (function () {
      function extractValue(cell, type) {
        if (!cell) {
          return { blank: true, value: "" };
        }
        const orderAttr = cell.getAttribute("data-order");
        if (orderAttr !== null) {
          const numericOrder = Number(orderAttr);
          if (!Number.isNaN(numericOrder)) {
            return { blank: false, value: numericOrder };
          }
          return { blank: false, value: orderAttr };
        }
        const text = (cell.textContent || "").trim();
        if (!text || text === "â€”") {
          return { blank: true, value: text };
        }
        if (type === "number") {
          const cleaned = text.replace(/[^0-9.-]/g, "");
          const numeric = parseFloat(cleaned);
          if (Number.isNaN(numeric)) {
            return { blank: true, value: text };
          }
          return { blank: false, value: numeric };
        }
        if (type === "date") {
          const timestamp = Date.parse(text);
          if (!Number.isNaN(timestamp)) {
            return { blank: false, value: timestamp };
          }
        }
        return { blank: false, value: text.toLowerCase() };
      }

      function sortTable(table, columnIndex, header) {
        const tbody = table.tBodies[0];
        if (!tbody) {
          return;
        }

        const rows = Array.from(tbody.querySelectorAll("tr"));
        const sortableRows = rows.filter(row => !row.classList.contains("table-placeholder"));
        const placeholderRows = rows.filter(row => row.classList.contains("table-placeholder"));

        const headers = Array.from(table.querySelectorAll("thead th"));
        headers.forEach(th => {
          if (th !== header) {
            th.dataset.sortDirection = "";
            th.classList.remove("sorted-asc", "sorted-desc");
          }
        });

        const currentDirection = header.dataset.sortDirection === "asc" ? "asc" : header.dataset.sortDirection === "desc" ? "desc" : null;
        const nextDirection = currentDirection === "asc" ? "desc" : "asc";
        const directionFactor = nextDirection === "asc" ? 1 : -1;
        const sortType = header.dataset.sortType || "string";

        sortableRows.sort((rowA, rowB) => {
          const cellA = rowA.cells[columnIndex];
          const cellB = rowB.cells[columnIndex];
          const dataA = extractValue(cellA, sortType);
          const dataB = extractValue(cellB, sortType);

          if (dataA.blank && dataB.blank) {
            return 0;
          }
          if (dataA.blank) {
            return 1;
          }
          if (dataB.blank) {
            return -1;
          }

          if (typeof dataA.value === "number" && typeof dataB.value === "number") {
            return directionFactor * (dataA.value - dataB.value);
          }

          return directionFactor * String(dataA.value).localeCompare(String(dataB.value));
        });

        header.dataset.sortDirection = nextDirection;
        header.classList.toggle("sorted-asc", nextDirection === "asc");
        header.classList.toggle("sorted-desc", nextDirection === "desc");

        sortableRows.forEach(row => tbody.appendChild(row));
        placeholderRows.forEach(row => tbody.appendChild(row));
      }

      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".sortable-table").forEach(function (table) {
          const headers = table.querySelectorAll("thead th");
          headers.forEach(function (th, index) {
            if (th.dataset.sortable === "false") {
              return;
            }
            th.classList.add("sortable");
            th.addEventListener("click", function () {
              sortTable(table, index, th);
            });
          });
        });
      });
    })();
  </script>
{% endblock %}
