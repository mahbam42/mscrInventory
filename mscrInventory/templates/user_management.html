{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
    <div>
      <h2 class="mb-1">Manage Users &amp; Groups</h2>
      <p class="text-muted mb-0">Create accounts, adjust group membership, and reset passwords for your team.</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      {% if can_add_user %}
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
        <i class="bi bi-person-plus me-1"></i>
        Create User
      </button>
      {% endif %}
      {% if selected_user and can_change_user %}
      <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editUserModal">
        <i class="bi bi-pencil-square me-1"></i>
        Edit {{ selected_user.username }}
      </button>
      {% endif %}
      <a class="btn btn-outline-secondary" href="{{ admin_url }}">
        <i class="bi bi-box-arrow-up-right"></i>
        Open Django Admin
      </a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>All Users</span>
      <span class="badge bg-secondary">{{ users|length }} total</span>
    </div>
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th scope="col">Username</th>
            <th scope="col">Email</th>
            <th scope="col">Groups</th>
            <th scope="col">Status</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td class="fw-semibold">{{ user.username }}</td>
            <td>{% if user.email %}{{ user.email }}{% else %}<span class="text-muted">â€”</span>{% endif %}</td>
            <td>
              {% if user.groups.all %}
                {% for group in user.groups.all %}
                <span class="badge bg-dark-subtle text-dark me-1">{{ group.name }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">Unassigned</span>
              {% endif %}
            </td>
            <td>
              {% if user.is_active %}<span class="badge bg-success-subtle text-success">Active</span>{% else %}<span class="badge bg-danger-subtle text-danger">Inactive</span>{% endif %}
              {% if user.is_staff %}<span class="badge bg-primary-subtle text-primary">Staff</span>{% endif %}
            </td>
            <td class="text-end">
              {% if can_change_user %}
              <a class="btn btn-sm {% if selected_user and selected_user.id == user.id %}btn-secondary{% else %}btn-outline-primary{% endif %}" href="{% url 'manage_users' %}?user={{ user.id }}">
                Manage
              </a>
              {% else %}
              <span class="text-muted small">View only</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">No users found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if can_add_user %}
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createUserModalLabel">Create User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" novalidate>
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="action" value="create">
          {% for field in create_form %}
          <div class="mb-3">
            {% if field.widget.input_type == "checkbox" %}
            <div class="form-check">
              {{ field }}
              <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            </div>
            {% else %}
            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% endif %}
            {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
            {% if field.errors %}
            <div class="invalid-feedback d-block">{{ field.errors|join:", " }}</div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create User</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% if can_change_user and edit_form and selected_user %}
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">Edit {{ selected_user.username }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" novalidate>
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="action" value="update">
          <input type="hidden" name="user_id" value="{{ selected_user.id }}">
          <div class="alert alert-info d-flex align-items-center" role="status">
            <i class="bi bi-person-fill me-2"></i>
            Updating <strong class="ms-1">{{ selected_user.username }}</strong>
          </div>
          {% for field in edit_form %}
          <div class="mb-3">
            {% if field.widget.input_type == "checkbox" %}
            <div class="form-check">
              {{ field }}
              <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            </div>
            {% else %}
            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% endif %}
            {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
            {% if field.errors %}
            <div class="invalid-feedback d-block">{{ field.errors|join:", " }}</div>
            {% endif %}
          </div>
          {% endfor %}
          <p class="text-muted small mb-0">Leave password blank to keep the current value.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  (() => {
    const createModalShouldOpen = {% if create_form.is_bound and create_form.errors %}true{% else %}false{% endif %};
    const editModalShouldOpen = {% if edit_form and edit_form.is_bound and edit_form.errors %}true{% elif selected_user and can_change_user and not create_form.is_bound %}true{% else %}false{% endif %};
    if (createModalShouldOpen) {
      const modalEl = document.getElementById('createUserModal');
      if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      }
    }
    if (editModalShouldOpen) {
      const modalEl = document.getElementById('editUserModal');
      if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      }
    }
  })();
</script>
{% endblock %}
